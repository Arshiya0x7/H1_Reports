{
  "id": 1130874,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTMwODc0",
  "url": "https://hackerone.com/reports/1130874",
  "title": "Post-Auth Blind NoSQL Injection in the users.list API leads to Remote Code Execution",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2021-03-19T17:31:20.816Z",
  "submitted_at": "2021-03-19T17:31:20.862Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "sonarsource",
    "url": "/sonarsource",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/ek9e0v6c0jrxkoyirgujw9qft5fb/3cb67cc78dc0cba55b102dd9eca2ee89b206d3e960be830f070583d9070b69ef"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 19858,
    "url": "https://hackerone.com/rocket_chat",
    "handle": "rocket_chat",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/019/858/ada6c92a338715afad123af214dd6e22fd8dc6ff_original.png/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/019/858/ada6c92a338715afad123af214dd6e22fd8dc6ff_original.png/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c"
    },
    "permissions": [],
    "submission_state": "paused",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": false,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "Rocket.Chat",
      "twitter_handle": "RocketChat",
      "website": "https://rocket.chat",
      "about": "Rocket.Chat is a company built on open source values and a love for efficiency. The company is driven by our amazing community of contributors."
    }
  },
  "has_bounty?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2021-22910"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2021-07-31T08:31:05.616Z",
  "bug_reporter_agreed_on_going_public_at": "2021-07-01T08:31:04.514Z",
  "team_member_agreed_on_going_public_at": null,
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "**Summary:**\nThe `users.list` API endpoint is vulnerable to NoSQL injection attacks. It can be used to take over accounts by leaking password reset tokens and 2FA secrets. Taking over an admin account leads to Remote Code Execution.\n\n**Description:**\nThe `users.list` API endpoint takes a custom query via the `query` URL query parameter. Although the returned fields are restricted, the query is not validated or sanitized properly and can thus be used to perform a blind NoSQL injection that can leak any field's value of any document in the `users` collection.\n\nBy using [MongoDB's `$where` operator](https://docs.mongodb.com/manual/reference/operator/query/where/), an attacker can build arbitrary oracles that can leak the value of any field of any user document. The query can be tailored to leak only the values of a specific account which makes it easy to target an admin account. Most notably an attacker can leak password reset tokens and 2FA secrets.\n\nExample: in order to check if the password reset token of an admin user begins with a specific letter, e.g. `A`, the attacker would send the JSON object `{\"$where\":\"this.roles.includes('admin') && /^A/.test(this.services.password.reset.token)\"}` as the `query` parameter. The response contains the matching admin user when the guess was correct, or no users otherwise. This can be repeated for all possible characters and for each position in the token, until the whole token is known. See the `users_nosqli_blind_leak` function in the attached exploit for an implementation of this.\n\nIn order to take over another account, an attacker would perform the following high-level steps:\n1. Leak the user's email address\n1. Request a password reset for the target user's account\n1. Leak the password reset token\n1. Leak the TOTP 2FA secret or email 2FA token hash if necessary\n1. Reset the target user's password to an attacker known one using the password reset token and any leaked 2FA tokens/secrets if necessary\n\nTo gain Remote Code Execution capabilities on the server, an attacker can follow these steps to take over an admin account. The attacker can then use the newly gained admin privileges to create an incoming web hook that has a script. This allows them  to execute commands or get a shell on the server, because the script is executed on the server without a security boundary in place (which seems to be intended).\n\nThe vulnerable code can be found here: [users.js:230](https://github.com/RocketChat/Rocket.Chat/blob/eba1e9b3146e5102baed000953c2cb51930c345c/app/api/server/v1/users.js#L230-L237)\n\nSee `post_auth_nosqli.py` for a reference exploit and the attached video for a demonstration of it.\n\n## Releases Affected:\n- Tested on 3.12.1\n- Seems to be affected since 0.49.0 as the vulnerability was introduced in [commit 3112d22](https://github.com/RocketChat/Rocket.Chat/commit/3112d225fe1533dd77cfad7fff085d53d78c19f2#diff-84949efc4b8041a5ac51e7bcd0f2cd38b8fd3690f059235769ab437b453feab8R120)\n\n## Steps To Reproduce (from initial installation to vulnerability):\n1. Install Python3 (required by the exploit)\n1. Install the Python dependencies required by the exploit: `pip3 install requests bcrypt`\n1. Set up an instance of RocketChat 3.12.1, e.g. by cloning the repo and using Docker Compose:\n  1. `git clone git@github.com:RocketChat/Rocket.Chat.git`\n  1. `cd Rocket.Chat`\n  1. `git checkout tags/3.12.1`\n  1. `docker-compose up -d`\n1. Configure the instance with default settings\n1. Create a normal (non-admin) user with username `attacker` and password `attacker`\n1. Run the reference exploit against the instance: `python3 post_auth_nosqli.py -u attacker -p attacker 'http://localhost:3000'`\n1. The exploit should provide an interactive shell on the the server, use it to verify that you can execute commands as the rocketchat user: `whoami`\n\n## Supporting Material/References:\nThe attached proof-of-concept video shows the setup and exploitation of a fresh Rocket.Chat instance.\n**Please note:** The unsuccessful login at the end of the video does not mean that the exploit did not work, it just shows that the original admin password was restored (as stated in the exploits output). The exploit was successful, which can be seen by the output of the shell commands at the end of the exploit.\n\nThis is the exploit's output:\n```\n ___  ___  _ __   __ _ _ __ ___  ___  _   _ _ __ ___ ___ \n/ __|/ _ \\| '_ \\ / _` | '__/ __|/ _ \\| | | | '__/ __/ _ \\\n\\__ \\ (_) | | | | (_| | |  \\__ \\ (_) | |_| | | | (_|  __/\n|___/\\___/|_| |_|\\__,_|_|  |___/\\___/ \\__,_|_|  \\___\\___|\n\n[+] Found admin: username=admin id=56gyPQKt8Ff3Weowk\n[*] Leaking email...\n[+] Leaked email: admin@rocketchat.local\n[*] Leaking password hash...\n[+] Leaked password hash: $2b$10$ubhEIM/j6qLFNINHVbP.B.CJFCXagK7V5zD0Q8BYzs6UBlbBpiECa\n[+] Requesting password reset...\n[*] Leaking password reset token...\n[+] Leaked password reset token: ET4sx905cF9pTZOsHFu6eRad7MwpYmqs-iTMWQIXAhv\n[+] Resetting password to \"DEbCf2b0A2BE79bBcDf1\"...\n[+] Admin account takeover successful!\n[+] Creating hook \"backdoor-9Fbd6E5A\" with secret \"AbE217B9d9e7Dd0CB2EB8dd30d26edfe\"...\n[*] Hook: 7bgxdkGHQYdBwtHWA/2S3EGB2ywWHM3aeYKu2q7akGF6TEjXEKMGK2Smggw7LpSLHc\n[+] Restoring admin password...\n[+] Dropping into shell:\n$ whoami\nrocketchat\n$ id\nuid=65533(rocketchat) gid=65533(rocketchat) groups=65533(rocketchat)\n$ \n```\n\n## Suggested mitigation\n- Properly validate the `query` parameter:\n  - Restrict the usage of MongoDB operators using an allowlist, especially top level operators like `$where`\n  - Restrict the set of query-able fields using an allowlist (like the restriction on the returned fields)\n- Check every API endpoint that uses the `parseJsonQuery()` function for similar vulnerabilities\n\n## Disclosure Policy\nAll reported issues are subject to a 90 day disclosure deadline. \nAfter 90 days elapse, parts of the bug report will become visible to the public.\n\nDon't hesitate to ask if you have any questions or need further help with this issue.\n\n## Impact\n\nAn attacker can use this vulnerability to target an admin user and take over their account, which is already a high impact. The attacker can then use certain features that are available to admins in order to gain Remote Code Execution capabilities. This is demonstrated in the reference exploit by creating an incoming web hook that executes the attacker's payload in the context of the server process.\n\nThis gives them complete control over the Rocket.Chat instance and exposes all attached components, e.g. the database or any external system whose credentials are stored within Rocket.Chat settings. An attacker can read, change, or delete all items in the database, impacting confidentiality, integrity, and availability.",
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2021-07-31T08:31:04.622Z",
  "allow_singular_disclosure_after": -130700185.64901438,
  "singular_disclosure_allowed": true,
  "vote_count": 13,
  "voters": [
    "he4am",
    "ertugrul",
    "akashhamal0x01",
    "0nlymohammed",
    "pr0f0x01",
    "olegeekk",
    "41bin",
    "jesubalan",
    "acka",
    "u2618",
    "and 3 more..."
  ],
  "severity": {
    "rating": "high",
    "score": 8.8,
    "author_type": "User",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "low",
      "user_interaction": "none",
      "scope": "unchanged",
      "confidentiality": "high",
      "integrity": "high",
      "availability": "high"
    }
  },
  "structured_scope": null,
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
