{
  "id": 541169,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81NDExNjk=",
  "url": "https://hackerone.com/reports/541169",
  "title": "GitLab::UrlBlocker validation bypass leading to full Server Side Request Forgery",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2019-04-17T09:18:36.964Z",
  "submitted_at": "2019-04-17T09:18:36.964Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "ajxchapman",
    "url": "/ajxchapman",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/ey3f0qnxrppswp9im09fgv2kaecf/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 264,
    "url": "https://hackerone.com/gitlab",
    "handle": "gitlab",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "GitLab",
      "twitter_handle": "gitlab",
      "website": "https://about.gitlab.com",
      "about": "A single application for the entire software development lifecycle."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2019-12-12T11:56:05.168Z",
  "bug_reporter_agreed_on_going_public_at": "2019-12-11T10:18:56.271Z",
  "team_member_agreed_on_going_public_at": "2019-12-12T11:56:05.010Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "### Summary\nThe `GitLab::UrlBlocker` IP address validation methods suffer from a Time of Check to Time of Use (ToCToU) vulnerability. The vulnerability occurs due to multiple DNS resolution requests performed before and after the checks. This issue allows a malicious authenticated user to send GET and POST HTTP requests to arbitrary hosts, including the localhost, cloud metadata services and the local network, and read the HTTP response.\n\n### Details\nThe IP address validation code in `/lib/gitlab/url_blocker.rb` resolves the IP addresses of the provided URL domain, raises an exception if the resolved IP addresses match addresses in block lists (`127.0.0.1`, `::1`, `169.254.0.0/16`, etc.) or returns `true` if the IP address do not match the block lists.\n```ruby\n  begin\n    addrs_info = Addrinfo.getaddrinfo(uri.hostname, port, nil, :STREAM).map do |addr|\n      addr.ipv6_v4mapped? ? addr.ipv6_to_ipv4 : addr\n    end\n  rescue SocketError\n    return true\n  end\n\n  validate_localhost!(addrs_info) unless allow_localhost\n  validate_loopback!(addrs_info) unless allow_localhost\n  validate_local_network!(addrs_info) unless allow_local_network\n  validate_link_local!(addrs_info) unless allow_local_network\n\n  true\nend\n```\nIf the address validates the `GitLab::HTTP` code then uses `HTTParty` to request the URL, which performs a second URL domain DNS resolution. The address validation checks can be bypassed if the URL domain resolves to a valid address for the first resolution then a forbidden address after the checks are performed. \n\nIn order to perform this attack a DNS server must be configured to resolve a domain to alternating addresses with a low (or zero) Time To Live. To demonstrate this issue I used my researchersservers project (https://github.com/ajxchapman/sshreverseshell) with the configuration in {F470655}. Output of resolving `gitlabextssrf.webhooks.pw` against this DNS resolver configuration is shown below:\n```sh\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       127.0.0.1\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       127.0.0.1\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n```\nNotice the alternating resolved IP address and 0 ttl.\n\n### Attack scenario\nUsing the Web Hook integration functionality of a GitLab repository, this issue can be abused to send HTTP GET and POST requests to arbitrary IP addresses, with arbitrary path parameters. The following screenshot shows the response of an HTTP GET request to `http://169.254.169.254/metadata/v1.json` on a DigitalOcean droplet:\n{F470641}\n\n### Steps to reproduce\nTo demonstrate this issue I have configured the domain `gitladextssrf.webhooks.pw` to randomly resolve to either `198.211.125.160` or `127.0.0.1`.\n\n1. Create a new repository\n1. Add a commit to the repository\n1. Create a new Web Hook integration with the URL http://gitlabextssrf.webhooks.pw:9999.\n  * This may take several attempts due to the random nature of the `gitlabextssrf.webhooks.pw` DNS resolver, if it fails with a `500` error, try again until it is accepted.\n1. Log into the gitlab server and start a TCP listener on port 9999/tcp (e.g. `nc -vvn -l -p 9999`)\n1. Perform numerous parallel requests to the Web Hook test endpoint. For this I use `wfuzz`\n\n```sh\n$ ./wfuzz -X POST \\\n  -b \"_gitlab_session=<session_id>;\" \\\n  -d \"_method=post&authenticity_token=<token>\" \\\n  -z range,0-1000 \\\n  \"https://<domain>/<user>/<repo>/hooks/<hook_id>/test?trigger=push_events&test=FUZZ\"\n```\nThe the below video demonstration of reproducing this issue:\n{F470642}\n\nAfter several requests a connection will be made to the local TCP listener on port 9999/tcp.\n\n### Impact\nThis issue allows a malicious authenticated user to send GET and POST HTTP requests from the GitLab server to arbitrary hosts (including the localhost, cloud metadata services and the local network) with arbitrary paths, and read the HTTP response. This could be abused to compromise the host (e.g. leaking AWS tokens from the metadata service), or perform reconnaissance and exploitation of hosts on the local network.\n\n### What is the current *bug* behavior?\nThe `GitLab::UrlBlocker` validation code resolves the IP addresses of a URL domain, validates them against a series of block lists, and if valid returns to the `GitLab::HTTP` module which re-resolves the URL domain in order to perform the HTTP request.\n\n### What is the expected *correct* behavior?\nThe validated resolved addresses should be returned by `GitLab::UrlBlocker` and used by `GitLab::HTTP` to make the TCP connection to the destination host.\n\n### Relevant logs and/or screenshots\nOutput of using the ToCToU bypass in a Web Hook to send a request to the DigitalOcean droplet meta data API `http://169.254.169.254/metadata/v1.json` endpoint:\n{F470641}\n\n### Output of checks\n#### Results of GitLab environment info\n```sh\n$ gitlab-rake gitlab:env:info\n\nSystem information\nSystem:         Ubuntu 18.04\nProxy:          no\nCurrent User:   git\nUsing RVM:      no\nRuby Version:   2.5.3p105\nGem Version:    2.7.6\nBundler Version:1.16.6\nRake Version:   12.3.2\nRedis Version:  3.2.12\nGit Version:    2.18.1\nSidekiq Version:5.2.5\nGo Version:     unknown\n\nGitLab information\nVersion:        11.9.8-ee\nRevision:       c9701808101\nDirectory:      /opt/gitlab/embedded/service/gitlab-rails\nDB Adapter:     postgresql\nDB Version:     9.6.11\nURL:            https://gitlabext.webhooks.pw\nHTTP Clone URL: https://gitlabext.webhooks.pw/some-group/some-project.git\nSSH Clone URL:  git@gitlabext.webhooks.pw:some-group/some-project.git\nElasticsearch:  no\nGeo:            no\nUsing LDAP:     no\nUsing Omniauth: yes\nOmniauth Providers:\n\nGitLab Shell\nVersion:        8.7.1\nRepository storage paths:\n- default:      /var/opt/gitlab/git-data/repositories\nGitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell\nGit:            /opt/gitlab/embedded/bin/git\n```\n\nI have confirmed this issue on both the official Docker image and the official `gitlab-ee` Ubuntu package (using installation instructions from https://about.gitlab.com/install/#ubuntu).\n\n## Impact\n\nThis issue allows a malicious authenticated user to send GET and POST HTTP requests from the GitLab server to arbitrary hosts (including the localhost, cloud metadata services and the local network) with arbitrary paths, and read the HTTP response. This could be abused to compromise the host (e.g. leaking AWS tokens from the metadata service), or perform reconnaissance and exploitation of hosts on the local network.",
  "weakness": {
    "id": 68,
    "name": "Server-Side Request Forgery (SSRF)"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 470641,
      "file_name": "Screenshot_from_2019-04-17_09-18-49.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/641/30a1794b8ace50c8dab24743c5eb0336b4e3366f/Screenshot_from_2019-04-17_09-18-49.png?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_from_2019-04-17_09-18-49.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_from_2019-04-17_09-18-49.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQXH3IJ7M2%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T130325Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCmTN%2BvZcEFOamV0Kg8ZJ4ZxIvtcAOCyN2sQtXu9gL4BAIgFUd6qrFnO5TOJAxy7WY1pXtDVyW%2FtooSmtiO9RTHu8UqsQUIFRADGgwwMTM2MTkyNzQ4NDkiDC1Wp%2F3SwOPbRAuuxSqOBcNtuKGMZbO9qIc7GMcE%2F8JdLTMg1N3s89C0FYD8cHLkyrK9DZb4wQZ0Qx%2B%2FPvNAp6gkecweUHJhNibW59it0oZPn50ncqsxwetmpsOGO2gsUId8lI5I8NlXMo1QIUmQgdp95jxdkuXIFNeEqERTWy7Y8JMjoVPglw7kGxObClqZuxapxy%2FU%2FlTOpsh2Y6QUmhobAbDn1weImZdTqE%2BGNZbLB4swr5K7YMgZdhnrnhNKSQQWOvuhsu86TqsICbyL%2B%2B6HVTwpi0uFYSLbgId5h57LTAPskSE2leo%2FooZbDb7ozFHsT27L2bfXfNwa58NRoDwR5lI%2BqHoOTtxW0peKh3GzHtAYbkGSIxOab98d1YU1IYCgNe60AaUhfuFvX21qTItpTZjR7vIAhJ0SSZyqCz%2BJ%2BMga%2BdzPGJE9Jm2%2FVrR6XCTzgK2UFrTyC3fnRbHy5bgHs%2Bz9Y5iejYtmpQPmhTu7le%2Br1w78OhgzdqYD%2F%2Bn02PHHq6VM57QjcLmtaFpTbN%2B9WeKCHnG92Q1nJJvr%2FEawcnOYbtTjlvVvLDv5%2FpggzxVZOQvLOu9o0CdLw18a11d7TJegeDpHYHaI7ij0PBVxXESim5wQSxHQa2S6ZRyBj%2B0zF8xoMibRorSRmDLlEo42jSN2sQ%2BE7bt1yMGe9fBQexEP2aaVpcj4o17M4e%2FVgEi5kK8dVeeE8qxwJgTCu2t%2FuXdXJhYoAKEad6CwiDZVGIdxSxldTULy7H5b%2Fy84GQpUhe%2FeeYGje5viO7O1OKXWpOpVuHn%2BT6VJ5ewZ6R7MjE3BerIgPSAmbDZ%2FNPJN0IqvjcUTck4fBYNrvLbt0OJ2Nl9c3k67FWZ%2BtTFlCCXN98b8R%2F1D9E2CHd82rjD207%2FGBjqxAYgJC3SrIcWSgXMuw%2FprXbX0JnjDjFZ6rNP1n%2BL4G3zbvE5D%2B1rv8pDAjz9ogSPQFV297aM4%2Fnnf6c4Id8aU8x9VTjlc3THODgd5oYEYaoBHqLtWouDpm7p%2BU3O7gLEBuKy2e4%2Fpf1AmMYVjGfoynPb5zpA9kAZtEaJ2zETyM6%2Fh3rHyexd9a8lW7ulQ0vX4CXJSH1sd3qk4s9zUhHtowsaRknU2A50CXgZH9gCJjlaGBw%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=2f1d260fc827596aacc7df9bd57bc3c8e0aa830c8b901d1b7fc18865a2b3cd66",
      "file_size": 68517,
      "type": "image/png",
      "moderated": null
    },
    {
      "id": 470642,
      "file_name": "gitlab_ssrf.mp4",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/642/b1de89da2206e6799e15728bb745fefa9ae0081e/gitlab_ssrf.mp4?response-content-disposition=attachment%3B%20filename%3D%22gitlab_ssrf.mp4%22%3B%20filename%2A%3DUTF-8%27%27gitlab_ssrf.mp4&response-content-type=video%2Fmp4&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQXH3IJ7M2%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T130325Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCmTN%2BvZcEFOamV0Kg8ZJ4ZxIvtcAOCyN2sQtXu9gL4BAIgFUd6qrFnO5TOJAxy7WY1pXtDVyW%2FtooSmtiO9RTHu8UqsQUIFRADGgwwMTM2MTkyNzQ4NDkiDC1Wp%2F3SwOPbRAuuxSqOBcNtuKGMZbO9qIc7GMcE%2F8JdLTMg1N3s89C0FYD8cHLkyrK9DZb4wQZ0Qx%2B%2FPvNAp6gkecweUHJhNibW59it0oZPn50ncqsxwetmpsOGO2gsUId8lI5I8NlXMo1QIUmQgdp95jxdkuXIFNeEqERTWy7Y8JMjoVPglw7kGxObClqZuxapxy%2FU%2FlTOpsh2Y6QUmhobAbDn1weImZdTqE%2BGNZbLB4swr5K7YMgZdhnrnhNKSQQWOvuhsu86TqsICbyL%2B%2B6HVTwpi0uFYSLbgId5h57LTAPskSE2leo%2FooZbDb7ozFHsT27L2bfXfNwa58NRoDwR5lI%2BqHoOTtxW0peKh3GzHtAYbkGSIxOab98d1YU1IYCgNe60AaUhfuFvX21qTItpTZjR7vIAhJ0SSZyqCz%2BJ%2BMga%2BdzPGJE9Jm2%2FVrR6XCTzgK2UFrTyC3fnRbHy5bgHs%2Bz9Y5iejYtmpQPmhTu7le%2Br1w78OhgzdqYD%2F%2Bn02PHHq6VM57QjcLmtaFpTbN%2B9WeKCHnG92Q1nJJvr%2FEawcnOYbtTjlvVvLDv5%2FpggzxVZOQvLOu9o0CdLw18a11d7TJegeDpHYHaI7ij0PBVxXESim5wQSxHQa2S6ZRyBj%2B0zF8xoMibRorSRmDLlEo42jSN2sQ%2BE7bt1yMGe9fBQexEP2aaVpcj4o17M4e%2FVgEi5kK8dVeeE8qxwJgTCu2t%2FuXdXJhYoAKEad6CwiDZVGIdxSxldTULy7H5b%2Fy84GQpUhe%2FeeYGje5viO7O1OKXWpOpVuHn%2BT6VJ5ewZ6R7MjE3BerIgPSAmbDZ%2FNPJN0IqvjcUTck4fBYNrvLbt0OJ2Nl9c3k67FWZ%2BtTFlCCXN98b8R%2F1D9E2CHd82rjD207%2FGBjqxAYgJC3SrIcWSgXMuw%2FprXbX0JnjDjFZ6rNP1n%2BL4G3zbvE5D%2B1rv8pDAjz9ogSPQFV297aM4%2Fnnf6c4Id8aU8x9VTjlc3THODgd5oYEYaoBHqLtWouDpm7p%2BU3O7gLEBuKy2e4%2Fpf1AmMYVjGfoynPb5zpA9kAZtEaJ2zETyM6%2Fh3rHyexd9a8lW7ulQ0vX4CXJSH1sd3qk4s9zUhHtowsaRknU2A50CXgZH9gCJjlaGBw%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=a5451cd0a8bfba9cf2ffb36ad5cd139694ebc7f55809b1235dd5923ef767c36d",
      "file_size": 3640819,
      "type": "video/mp4",
      "moderated": null
    },
    {
      "id": 470655,
      "file_name": "41_gitlab.json",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/655/dde8d1548d92ff35d1c94fab303b8ff2492831aa/41_gitlab.json?response-content-disposition=attachment%3B%20filename%3D%2241_gitlab.json%22%3B%20filename%2A%3DUTF-8%27%2741_gitlab.json&response-content-type=text%2Fplain&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQXH3IJ7M2%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T130325Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCmTN%2BvZcEFOamV0Kg8ZJ4ZxIvtcAOCyN2sQtXu9gL4BAIgFUd6qrFnO5TOJAxy7WY1pXtDVyW%2FtooSmtiO9RTHu8UqsQUIFRADGgwwMTM2MTkyNzQ4NDkiDC1Wp%2F3SwOPbRAuuxSqOBcNtuKGMZbO9qIc7GMcE%2F8JdLTMg1N3s89C0FYD8cHLkyrK9DZb4wQZ0Qx%2B%2FPvNAp6gkecweUHJhNibW59it0oZPn50ncqsxwetmpsOGO2gsUId8lI5I8NlXMo1QIUmQgdp95jxdkuXIFNeEqERTWy7Y8JMjoVPglw7kGxObClqZuxapxy%2FU%2FlTOpsh2Y6QUmhobAbDn1weImZdTqE%2BGNZbLB4swr5K7YMgZdhnrnhNKSQQWOvuhsu86TqsICbyL%2B%2B6HVTwpi0uFYSLbgId5h57LTAPskSE2leo%2FooZbDb7ozFHsT27L2bfXfNwa58NRoDwR5lI%2BqHoOTtxW0peKh3GzHtAYbkGSIxOab98d1YU1IYCgNe60AaUhfuFvX21qTItpTZjR7vIAhJ0SSZyqCz%2BJ%2BMga%2BdzPGJE9Jm2%2FVrR6XCTzgK2UFrTyC3fnRbHy5bgHs%2Bz9Y5iejYtmpQPmhTu7le%2Br1w78OhgzdqYD%2F%2Bn02PHHq6VM57QjcLmtaFpTbN%2B9WeKCHnG92Q1nJJvr%2FEawcnOYbtTjlvVvLDv5%2FpggzxVZOQvLOu9o0CdLw18a11d7TJegeDpHYHaI7ij0PBVxXESim5wQSxHQa2S6ZRyBj%2B0zF8xoMibRorSRmDLlEo42jSN2sQ%2BE7bt1yMGe9fBQexEP2aaVpcj4o17M4e%2FVgEi5kK8dVeeE8qxwJgTCu2t%2FuXdXJhYoAKEad6CwiDZVGIdxSxldTULy7H5b%2Fy84GQpUhe%2FeeYGje5viO7O1OKXWpOpVuHn%2BT6VJ5ewZ6R7MjE3BerIgPSAmbDZ%2FNPJN0IqvjcUTck4fBYNrvLbt0OJ2Nl9c3k67FWZ%2BtTFlCCXN98b8R%2F1D9E2CHd82rjD207%2FGBjqxAYgJC3SrIcWSgXMuw%2FprXbX0JnjDjFZ6rNP1n%2BL4G3zbvE5D%2B1rv8pDAjz9ogSPQFV297aM4%2Fnnf6c4Id8aU8x9VTjlc3THODgd5oYEYaoBHqLtWouDpm7p%2BU3O7gLEBuKy2e4%2Fpf1AmMYVjGfoynPb5zpA9kAZtEaJ2zETyM6%2Fh3rHyexd9a8lW7ulQ0vX4CXJSH1sd3qk4s9zUhHtowsaRknU2A50CXgZH9gCJjlaGBw%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=0a3028de328e9562b8262a8e646b20c630b102200b1cbcc552b8cf6d457ec5e3",
      "file_size": 285,
      "type": "text/plain",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": null,
  "vote_count": 66,
  "voters": [
    "th3hidd3nmist",
    "djcater",
    "n1m0",
    "0xwintermute",
    "krevetk0",
    "dee-see",
    "ajxchapman",
    "p1stachios",
    "zonduu",
    "sourc7",
    "and 56 more..."
  ],
  "severity": {
    "rating": "high",
    "score": 7.6,
    "author_type": "User",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "low",
      "user_interaction": "none",
      "scope": "unchanged",
      "confidentiality": "high",
      "integrity": "low",
      "availability": "low"
    }
  },
  "structured_scope": {
    "databaseId": 18138,
    "asset_type": "URL",
    "asset_identifier": "gitlab.com",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
