{
  "id": 3484319,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zNDg0MzE5",
  "url": "https://hackerone.com/reports/3484319",
  "title": "MQTT Protocol Violation & Integer Overflow in libcurl",
  "state": "Closed",
  "substate": "informative",
  "severity_rating": "high",
  "readable_substate": "Informative",
  "created_at": "2026-01-01T21:51:13.454Z",
  "submitted_at": "2026-01-01T21:51:13.695Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "is_triager?": false,
  "reporter": {
    "disabled": false,
    "username": "ssyyaa",
    "url": "/ssyyaa",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/pfep1suhfttd55tb4jjnaeyp467h/c8a1698ff707a5e3e8a91a3484838363845daac68cb82c86d55c9e2d44d67b67"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 35663,
    "url": "https://hackerone.com/curl",
    "handle": "curl",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/035/663/2faf4c279d437d64bfda6d23d62ce1833813a4d9_original.png/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/035/663/2faf4c279d437d64bfda6d23d62ce1833813a4d9_original.png/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "curl",
      "twitter_handle": "",
      "website": "https://curl.se",
      "about": "cURL is an Open Source project providing a library and command-line tool doing internet transfers"
    }
  },
  "has_bounty?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2026-01-01T22:50:02.911Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2026-01-01T22:40:53.152Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "## Executive Summary\n\n**Vulnerability Type:** CWE-190\n**Component:** lib/mqtt.c  \n**Function:** mqtt_decode_len  \n\n**Affected Architectures:**\n- **All architectures:** Protocol non-compliance leading to stream desynchronization\n- **32-bit architectures:** Deterministic integer overflow in length decoding\n\nlibcurl does not correctly enforce the MQTT v3.1.1 specification limit for the “Remaining Length” field when decoding incoming packets. This allows malformed MQTT packets to be parsed incorrectly, leading to protocol desynchronization and potential denial of service. On 32-bit systems, the decoding logic additionally allows a deterministic integer overflow.\n\n---\n\n## Root Cause: Inconsistent Length Handling\n\nThe issue is caused by an inconsistency within `lib/mqtt.c`.  \nThe encoder correctly enforces the MQTT specification limit, while the decoder does not.\n\n### Correct Behavior (Encoding)\n\nIn `mqtt_encode_len`, the implementation explicitly limits the Remaining Length field to four bytes, as required by the specification:\n\n```c\nfor(i = 0; (len > 0) && (i < 4); i++) {\n  unsigned char encoded;\n  encoded = len % 0x80;\n  /* ... */\n}\n````\n\nThis ensures protocol compliance.\n\n### Incorrect Behavior (Decoding)\n\nIn contrast, `mqtt_decode_len` does not enforce the same limit:\n\n```c\nfor(i = 0; (i < buflen) && (encoded & 128); i++) {\n  encoded = buf[i];\n  len += (encoded & 127) * mult;\n  mult *= 128;\n}\n```\n\nThe loop continues as long as the continuation bit is set and input is available, allowing more than four bytes to be consumed as part of the Remaining Length field.\n\n---\n\n## Specification Violation\n\nAccording to the MQTT v3.1.1 specification, Section 2.2.3 (Remaining Length):\n\n> “The number of bytes in the Remaining Length field MUST NOT exceed four bytes.”\n\nBy accepting and processing length fields longer than four bytes, libcurl violates the MQTT specification and enters an undefined protocol state.\n\n---\n\n## Integer Overflow on 32-bit Systems\n\nOn 32-bit architectures, `size_t` is a 32-bit unsigned integer.\nThe variable `mult` is repeatedly multiplied by 128 during decoding.\n\nExample progression on a 32-bit system:\n\n| Iteration | mult value  | Operation | Result           |\n| --------: | ----------- | --------- | ---------------- |\n|         0 | 1           | 1 × 128   | 128              |\n|         1 | 128         | 128 × 128 | 16,384           |\n|         2 | 16,384      | × 128     | 2,097,152        |\n|         3 | 2,097,152   | × 128     | 268,435,456      |\n|         4 | 268,435,456 | × 128     | **Overflow → 0** |\n\nAfter the overflow, `mult` becomes zero, and any further bytes consumed contribute nothing to the decoded length. This allows a large or malformed Remaining Length field to be partially “hidden” while still advancing the input pointer.\n\n---\n\n## Impact\n\n# Impact\n\n### Protocol Desynchronization (All Architectures)\n\nBy consuming more than four bytes for the Remaining Length field, libcurl can become desynchronized from the MQTT stream. Bytes intended to be part of the payload or subsequent packets may instead be interpreted as length data, causing incorrect parsing of later packets.\n\n### Denial of Service\n\nThis desynchronization can result in malformed packet handling, unexpected connection termination, or repeated protocol errors such as `CURLE_WEIRD_SERVER_REPLY`.\n\nNo memory corruption or code execution is claimed.\n\n---\n\n## Recommended Fix\n\nThe decoding logic should explicitly enforce the four-byte limit defined by the MQTT specification.\n\nExample fix:\n\n```c\nfor(i = 0; (i < buflen) && (encoded & 128); i++) {\n  if(i >= 4) {\n    /* Malformed Remaining Length */\n    return 0; /* or propagate an error to the caller */\n  }\n  encoded = buf[i];\n  len += (encoded & 127) * mult;\n  mult *= 128;\n}\n```\n\nOptionally, the decoded length can also be checked against the implementation limit:\n\n```c\nif(len > MAX_MQTT_MESSAGE_SIZE)\n  return 0;\n```\n\n---\n\n## Verification Notes\n\nThe issue was verified through code inspection and logic simulation, confirming that `mqtt_decode_len` accepts more than four bytes for the Remaining Length field and allows arithmetic overflow on 32-bit systems. Runtime exploitation was not required to demonstrate the protocol violation.\n\n---\n\n## Conclusion\n\nThis is a protocol parsing bug caused by missing enforcement of a mandatory MQTT specification limit. While it does not directly result in memory corruption, it allows malformed MQTT packets to desynchronize the client’s protocol state and cause denial of service. Aligning the decoder with the existing encoder logic resolves the issue cleanly.\n\n```",
  "weakness": {
    "id": 15,
    "name": "Integer Overflow"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 5176784,
      "file_name": "mqtt_malicious_server.py",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/mkm0k9jpwm1e2ghyc1d7vmn2d36p?response-content-disposition=attachment%3B%20filename%3D%22mqtt_malicious_server.py%22%3B%20filename%2A%3DUTF-8%27%27mqtt_malicious_server.py&response-content-type=text%2Fx-python&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQWBJO7RH4%2F20260101%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20260101T230508Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjECUaCXVzLXdlc3QtMiJHMEUCICuVwYJuQCpMfnZDAr4j0aQCG6kapnTlp2lzimWhxoj4AiEA3aPDU%2BuTpNHIrkQoawKp3LSNBo3HeIxF%2BPDuKWr7HREquwUI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARADGgwwMTM2MTkyNzQ4NDkiDA4NuZOlhYGoh%2F2%2FFCqPBdHTCaw6kTRkhdEtYQQqz73HfxzzW24IhxCjp7LP9qwZNiMyXjFL3gWz8xcCZ310Lqyp2jIvTGOTz4ElQ0BosCDinUxBnXmj%2BNTNgq6NC2NwjdlzmMPd4mme1DlviSw%2FhegImkGava8p2cZwxLB4HsypI0EEkP41GnWOxecUzc1sdF2Ht81502Xq9YuCH6kGqhocwqi6SFtj%2Bn%2FxV%2FcfsBfLaPpLC%2B02SCWKyZ08T%2BesQLRE79u6YDWmePcDuXi%2B1WjH8YvB6BdpogYpGM48gpwhkq9ljviNQbMFsET2CE7tQAUO2fwC0zhU8nUcS7zV2HTDstUQ7nY7Wkttv8GuzmRB%2FrSeMzGQaEM1DPRSabfCS4qLKs9j6CwNZ93bexbmvNMKfQ4s1nj2V1%2BeGh95rZBPTrs12OVqv38not6zZUBhIhJBTuLuJr%2BYuBEXGJZPX%2BtxaJ1CU5%2BfbdwOi4f%2BGJ3WHlPQtTMjlkPVz7A%2BKJjXiU3p7E8WehiluaMl7ZlOc12cULk5HBSvt6LeyuOhBQdAXxew4b24%2BfLNEgOR8c%2FH5tDx8UcCtWqGMhMZeG1Cfqv5h42HOL9nId02MS%2FAURmbGPtybjXcDbc9st%2FTwXaoVgEPklWqyCbJqSzBmzGGtdkC%2BewEkXzCOpofUiy7hghAYhqPOk%2FA6nBVTp5TEOSctTUOwD5or9d%2FmgYU8t%2B7IUvJ7WFbG0zEG059wBYoI7gicHwrA%2Be5gFzFHS%2Fci8U31V4qO1ouQ8jLFbLGa5cQMXnPp8T2YPB%2FhpvxBTViad3OJIbpYuAUEhOE%2BCAQ998oz7T5P9ZcV18egiT3b9ky%2FIylHw%2BWio1walMFF2%2F1%2FIUmjjTj7HTh0kKnYjf%2BvKkwsrfbygY6sQHB2STKKqGaW9pK5v%2BSalsIcr9ILpqjQZcyKzWrLuGqVLjZ33Ss1XFI2ugmxSk%2FTsUFJS%2ByCA1%2BdQIhFykph3msCdz4gE5L31CCB6sKEW1pBuUtLU5Bn35kJ%2F%2BmwMlQpwpJXZDphsDH94fNi9xZ8XwzGTvoAWl2cgqzpZ1UrmJ3NzdjDRq63PlwCUbhbpG%2FzriiKoxSfEw3APVFL0nRV12to%2Fub1S%2FkXoc3l1EzCqonyiE%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=2446234f0dc30cbeb5f871c4f460dad24c5049b81031833ab618064548599f5c",
      "file_size": 2378,
      "type": "text/x-python",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": null,
  "vote_count": 0,
  "voters": [],
  "severity": {
    "rating": "high",
    "author_type": "User"
  },
  "structured_scope": {
    "databaseId": 18844,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "https://github.com/curl/curl",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
