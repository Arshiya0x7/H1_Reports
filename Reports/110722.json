{
  "id": 110722,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTA3MjI=",
  "url": "https://hackerone.com/reports/110722",
  "title": "Heap BufferOver Flow in escapeshellargs and escapeshellcmd functions",
  "state": "Closed",
  "substate": "resolved",
  "readable_substate": "Resolved",
  "created_at": "2016-01-14T17:23:22.482Z",
  "submitted_at": "2016-01-14T17:23:22.482Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "libnex",
    "url": "/libnex",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/002/468/f5a6e39ea76748aa48e36e0087eb8b09ff892d6c_original.png/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ3BMH67TU%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T133254Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIFljCnxBRm4k3mDOCNsZVf17QtNFYCYfznQ9MVhsJmuuAiBbOK8n3QO%2BoA%2BcJOaPEjuo2OnpQxXeGtV5gblrabFkdCqyBQgVEAMaDDAxMzYxOTI3NDg0OSIMu%2FDXvvg9fcRigun4Ko8Fb5ZIEjeevQoEG0l2BV%2BGWxg8S5ceOIpi9Vj5rzWvu%2FU8ULagtSQacHoYerVTS2w5mxb8q2eMyDWfB3WNcZp2jYoblOAOjGDkxFv0UfNMGU5qBv8audlGkD9bBj7k%2BPMh1elv8KOf5TSPS1TQgzoRPT1X5zf%2BUitErQDeos7hOVB27j0jmNUSU%2F62uqEpN5zzc4JDV6qPsWi%2B3MT7xqLVxQJaxMs0BkmYUNt%2BmDm6e8GkmRyyDXloQWuPJgbGwFgpcx1lE%2FdqBKny4rF9VApD%2Bs3l6I0ljLykB%2BCAK%2ByAA2z9BvFFoIk%2FxFSOlqls4xp47H51RxUBx5QVAlzxlLSqqtF07ygbOI3nWSDkXBRBh71ODGwtYPklYcAy%2BN1JIBRkTSB7P%2FApcdK%2F2HJmJmi3mNdO8DjUSAXt%2B6xrNOM7xjPuxOtz0db7fZdSmKKXvxlxi%2FTAaoM9F%2BJZ%2FGncN9cCvXkZHfTe4DQMnxULaVvxM40oXz7SvblcQoTgQTDcLUck%2BJiDf9fMLCu8HBz%2BOUAJggeTTLzasHSrySGvIpMTBuffvnBnnVa29Mm7K2WlV5wJE0i2vDjyh%2FZ8ERYD2u7%2BpaWooSen17bTtOgBA8rpw8Ca%2BBBCzBGJ4Jnv%2F7Vg5I0t6bT1RKrC%2B7ruuT8oH02SYFfBbc0AVE3YoRZ4c%2F81%2Bve3MDQo93OTxMwPyuEph5zyT%2F0uL36Kog%2FL0%2FHDLWxDoqCho4dyn8yODfz3VOrE5u7jsSac%2FAVh9AlbPuCB5Fz0%2F0dBqb2vPihtVHnRr1%2BaD8HcuNsV6UwuWtYjabks5SXoSh4sDkBV0QjqYgyQT%2F2xrYwkHJGgNRZg7X%2B0GQB2W6JfoK%2Bk8n6dhdDh9N%2BC%2FTCr1b%2FGBjqyAVVK9luJ2DpE2HH7QULrpYu01A8Fm4WvVccUWw3poFTPvtokByojqV9CgizgRjo2wHFdocvJ4lpbjnQjjxMkbJLK%2FW9qfA7eVQzSnDC7HGaYVsiUekGk4%2BmwXx7iMvjgYSnBoKWAaBqd3fRqTEW4g3lhzi7lOpTLcWZp60Ya9y2Gr9bjvLCe2g89bmHm9cxzB7H7SDaXF159IthNc4CVFX2TMwhNV%2BaVJ6D%2B6UC7%2Bp%2FLkJ8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=493f60d6678233fc8e78fc373102305503603ec22e6ff84ea2dfffcc16e02432",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ3BMH67TU%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T133254Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIFljCnxBRm4k3mDOCNsZVf17QtNFYCYfznQ9MVhsJmuuAiBbOK8n3QO%2BoA%2BcJOaPEjuo2OnpQxXeGtV5gblrabFkdCqyBQgVEAMaDDAxMzYxOTI3NDg0OSIMu%2FDXvvg9fcRigun4Ko8Fb5ZIEjeevQoEG0l2BV%2BGWxg8S5ceOIpi9Vj5rzWvu%2FU8ULagtSQacHoYerVTS2w5mxb8q2eMyDWfB3WNcZp2jYoblOAOjGDkxFv0UfNMGU5qBv8audlGkD9bBj7k%2BPMh1elv8KOf5TSPS1TQgzoRPT1X5zf%2BUitErQDeos7hOVB27j0jmNUSU%2F62uqEpN5zzc4JDV6qPsWi%2B3MT7xqLVxQJaxMs0BkmYUNt%2BmDm6e8GkmRyyDXloQWuPJgbGwFgpcx1lE%2FdqBKny4rF9VApD%2Bs3l6I0ljLykB%2BCAK%2ByAA2z9BvFFoIk%2FxFSOlqls4xp47H51RxUBx5QVAlzxlLSqqtF07ygbOI3nWSDkXBRBh71ODGwtYPklYcAy%2BN1JIBRkTSB7P%2FApcdK%2F2HJmJmi3mNdO8DjUSAXt%2B6xrNOM7xjPuxOtz0db7fZdSmKKXvxlxi%2FTAaoM9F%2BJZ%2FGncN9cCvXkZHfTe4DQMnxULaVvxM40oXz7SvblcQoTgQTDcLUck%2BJiDf9fMLCu8HBz%2BOUAJggeTTLzasHSrySGvIpMTBuffvnBnnVa29Mm7K2WlV5wJE0i2vDjyh%2FZ8ERYD2u7%2BpaWooSen17bTtOgBA8rpw8Ca%2BBBCzBGJ4Jnv%2F7Vg5I0t6bT1RKrC%2B7ruuT8oH02SYFfBbc0AVE3YoRZ4c%2F81%2Bve3MDQo93OTxMwPyuEph5zyT%2F0uL36Kog%2FL0%2FHDLWxDoqCho4dyn8yODfz3VOrE5u7jsSac%2FAVh9AlbPuCB5Fz0%2F0dBqb2vPihtVHnRr1%2BaD8HcuNsV6UwuWtYjabks5SXoSh4sDkBV0QjqYgyQT%2F2xrYwkHJGgNRZg7X%2B0GQB2W6JfoK%2Bk8n6dhdDh9N%2BC%2FTCr1b%2FGBjqyAVVK9luJ2DpE2HH7QULrpYu01A8Fm4WvVccUWw3poFTPvtokByojqV9CgizgRjo2wHFdocvJ4lpbjnQjjxMkbJLK%2FW9qfA7eVQzSnDC7HGaYVsiUekGk4%2BmwXx7iMvjgYSnBoKWAaBqd3fRqTEW4g3lhzi7lOpTLcWZp60Ya9y2Gr9bjvLCe2g89bmHm9cxzB7H7SDaXF159IthNc4CVFX2TMwhNV%2BaVJ6D%2B6UC7%2Bp%2FLkJ8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=d58c18a6abd2f5c771d2047f3a85930ad45f01184df7873559513a4b504236b9"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2019-11-12T09:38:12.891Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2019-10-13T09:38:09.822Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "1) Bug report: https://bugs.php.net/bug.php?id=71270\n2) Patch submitted and accepted: https://github.com/php/php-src/commit/2871c70efaaaa0f102557a17c727fd4d5204dd4b\n\n---Description---\n\n\n1)I found this vulnerability using a custom PHP engine fuzzer that I wrote. There exist a heap-based buffer over flow that allows one to write a user tainted data pass an allocated buffer. This vulnerability lies in the following functions:\n\tescapeshellarg \n\tescapeshellcmd \n\n2) On a default php installation, the memory limit is set to 128MB and this vulnerability is not triggerable. My analysis shows that this is triggerable when memory limit is roughly > 1024mb. A quick search on github shows that it's not uncommon to see code like \"ini_set('memory_limit', -1);\"\n\n\n3)I've created a POC that triggers the buffer over write with 0x414141414141.....\n\n4) A string of 1024mb is created and passed into escapeshellarg. \"l\" contains the length of this string:\n\nBreakpoint 2, php_escape_shell_arg (str=0x7fffad469028 'A' <repeats 200 times>...) at /home/elaw/php-7.0.0/ext/standard/exec.c:343\n343             int x, y = 0, l = (int)strlen(str);\n\ngdb-peda$ print l\n$43 = 0x40000000            // 1024mb\n\n\n\n5) This length \"l\" is then passed into zend_string_alloc as \"4 * l + 2\" which results in an integer overflow:\n\nTemporary breakpoint 3, php_escape_shell_arg (str=0x7fffad000018 'A' <repeats 200 times>...) at /home/elaw/php-7.0.1/ext/standard/exec.c:348\n348             cmd = zend_string_alloc(4 * l + 2, 0); /* worst case */\n\n\ngdb-peda$ print 4* l + 2\n$44 = 0x2 \t\t\t\t   //Overflow\n\n\n6) Stepping into zend_string_alloc to verify the integer overflow. Notice len=0x2:\nzend_string_alloc (persistent=0x0, len=0x2) at /home/elaw/php-7.0.0/Zend/zend_string.h:121      \n121             zend_string *ret = (zend_string *)pemalloc(ZEND_MM_ALIGNED_SIZE(_ZSTR_STRUCT_SIZE(len)), persistent);\n\n\n7) Lets confirm the overflow again in the allocated (zend_string *) cmd. Notice cmd.len=0x2:\ngdb-peda$ p *cmd\n$52 = {\n  gc = {\n    refcount = 0x1,\n    u = {\n      v = {\n        type = 0x6,\n        flags = 0x0,\n        gc_info = 0x0\n      },\n      type_info = 0x6\n    }\n  },\n  h = 0x0,\n  len = 0x2,\n  val = \"1\"\n}\n\n\n\n8) The loops then writes pass the allocated buffer in\n\n258\t\tfor (x = 0, y = 0; x < l; x++) {\n....\n321       ZSTR_VAL(cmd)[y++] = str[x];\n\n\n\n9) Verifying the buffer overflow in \ngdb-peda$ p (zend_string *)cmd.len\n$9 = (zend_string *) 0x2\ngdb-peda$ x/100b (zend_string *)cmd.val\n0x1625a58:      0x27    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625a60:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625a68:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625a70:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625a78:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625a80:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625a88:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625a90:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625a98:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625aa0:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625aa8:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625ab0:      0x41    0x41    0x41    0x41    0x41    0x41    0x41    0x41\n0x1625ab8:      0x41    0x41    0x41    0x41\n\n\n10) The vulnerability for php_escape_shell_cmd is identical.",
  "bounty_amount": "500.0",
  "formatted_bounty": "$500",
  "weakness": {
    "id": 2,
    "name": "Memory Corruption - Generic"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2019-11-12T09:38:09.903Z",
  "allow_singular_disclosure_after": -184910084.74856102,
  "singular_disclosure_allowed": true,
  "vote_count": 2,
  "voters": [
    "libnex",
    "dyabla"
  ],
  "structured_scope": {
    "databaseId": 84120,
    "asset_type": "OTHER",
    "asset_identifier": "PHP",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
