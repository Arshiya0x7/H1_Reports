{
  "id": 2434811,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNDM0ODEx",
  "url": "https://hackerone.com/reports/2434811",
  "title": "Path traversal by monkey-patching Buffer internals",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2024-03-26T14:50:28.450Z",
  "submitted_at": "2024-03-26T14:50:29.613Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "tniessen",
    "url": "/tniessen",
    "profile_picture_urls": {
      "small": "/assets/avatars/default-14ffa99f59cd01423c64904352cc130ffcb6a802eadfd11777a54485749e60f2.png"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ75B57S52%2F20250920%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250920T185246Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIE%2BgchX9JTqHlw5doTQtHfduNiCY02NVh%2FTpcyFH31dkAiATLfZb4I2jyzsPqzC%2Bn9wqWIYfiIjbjIkQdhwfOQ4XlSq7BQjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAMaDDAxMzYxOTI3NDg0OSIMEWCgTedrfEPc6GXSKo8FhzmZ7I87jx37A1z2z10yPATcLxx1Oj0f1M0S8WPvD183VGqg4W66MD5upXU%2FssuJ2sQZ1lUAggDL5iM%2B44nFndv9N%2FCI2HfJIf5QB2a9vq5Nk0CKgFRHlpVvE9p7e%2BUw99iIWxq6VcYP5FRNdZ9DStIjdo6vd0nv0Ql8ge2NADkPOs90o9SzR6eENt8b7B1lkQcY90bFYtfiYWKHK8Nnf1QA8ugMbRglhqzS9GkZ94Npv5LTgYvTPVUzsu1YbG4WdjAYMY%2FRseyaicTSfSHARvYt%2B5F6bCDQX%2F1%2BCUaGoX2WKfEME3W0ggG613lVGPFSx0LhH%2BaVmhvDjJL%2B1pSsKApq3EgZl4OnLcE3rduJbU1qrXbsHGB8BhwrQqccXLmTDQSPuGXjYWbYakpOMi0iDyXYQdTZbC2VwwPPU74a0xyf0gjpmUqf%2FHUcCXL71szV85IbWIgo2ElM4%2BxyzSJ7T3J7TaGJMIOY74m8AGiyWpiwBLLGTALXoJ6rQu%2FblohbeRwT%2FdfcxKN1pv2KZDzQhybSOReIyqyC2Qe9JCM%2F3xgP1IvPHsu9MnEI4e4%2F%2FALfThV1a3tX3fTLXtysfl5UnRc6XyU7gwHu4qc2PxKm3eSdHZjKDO1o9j2RoIHLF%2FmxItQ2XG0I7IYEnZ%2B14iuyKLJ7FwAeGgWdoGYW%2FzFCXlJRPzIEBzzkfFupzpubkYyeoJPHhR1rm2utUyBJiZKSYBxA3CYb61k6rN7hwf9%2FAEyVe8eYNVniCJIjDMFjmXNWLFXDnQSQGc%2Fb4kBbj4kgBOpMVIJzcm%2BQLGnzzZwm%2FQqaiQoM2sgGdQesRuav4fPZ1pgcUfQcxN0MXYgpHEjSe%2BviKgg%2BDGSkIF%2F8wub3cjCe%2FbrGBjqyARYWynJYwOjfynDPhjVK%2FH9eye8krLCnrmCRs42QdJsFYTbUuTG9QXvo8uVY%2BWKujV5rZ38tCPfxYDigPDZIm5HwzhVyN6fDKpHwHFLqPoXdGl0m6K7zsnyBd7nOaKX5dXVjsQcC8DseurEd4HkVd1WLiGbV9ADtyhKGQVof5WWTwr49E6NiUGsD97oZmq6kpn0Qy5BcdmxgEnT6%2FIFlxfJkbm93L59dItI6f3clT%2FrzMaQ%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=4999ee0aa1d1060079cda3fd3c44154c71baac02fc7861ebc34c05ddb4fb9b44",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ75B57S52%2F20250920%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250920T185246Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIE%2BgchX9JTqHlw5doTQtHfduNiCY02NVh%2FTpcyFH31dkAiATLfZb4I2jyzsPqzC%2Bn9wqWIYfiIjbjIkQdhwfOQ4XlSq7BQjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAMaDDAxMzYxOTI3NDg0OSIMEWCgTedrfEPc6GXSKo8FhzmZ7I87jx37A1z2z10yPATcLxx1Oj0f1M0S8WPvD183VGqg4W66MD5upXU%2FssuJ2sQZ1lUAggDL5iM%2B44nFndv9N%2FCI2HfJIf5QB2a9vq5Nk0CKgFRHlpVvE9p7e%2BUw99iIWxq6VcYP5FRNdZ9DStIjdo6vd0nv0Ql8ge2NADkPOs90o9SzR6eENt8b7B1lkQcY90bFYtfiYWKHK8Nnf1QA8ugMbRglhqzS9GkZ94Npv5LTgYvTPVUzsu1YbG4WdjAYMY%2FRseyaicTSfSHARvYt%2B5F6bCDQX%2F1%2BCUaGoX2WKfEME3W0ggG613lVGPFSx0LhH%2BaVmhvDjJL%2B1pSsKApq3EgZl4OnLcE3rduJbU1qrXbsHGB8BhwrQqccXLmTDQSPuGXjYWbYakpOMi0iDyXYQdTZbC2VwwPPU74a0xyf0gjpmUqf%2FHUcCXL71szV85IbWIgo2ElM4%2BxyzSJ7T3J7TaGJMIOY74m8AGiyWpiwBLLGTALXoJ6rQu%2FblohbeRwT%2FdfcxKN1pv2KZDzQhybSOReIyqyC2Qe9JCM%2F3xgP1IvPHsu9MnEI4e4%2F%2FALfThV1a3tX3fTLXtysfl5UnRc6XyU7gwHu4qc2PxKm3eSdHZjKDO1o9j2RoIHLF%2FmxItQ2XG0I7IYEnZ%2B14iuyKLJ7FwAeGgWdoGYW%2FzFCXlJRPzIEBzzkfFupzpubkYyeoJPHhR1rm2utUyBJiZKSYBxA3CYb61k6rN7hwf9%2FAEyVe8eYNVniCJIjDMFjmXNWLFXDnQSQGc%2Fb4kBbj4kgBOpMVIJzcm%2BQLGnzzZwm%2FQqaiQoM2sgGdQesRuav4fPZ1pgcUfQcxN0MXYgpHEjSe%2BviKgg%2BDGSkIF%2F8wub3cjCe%2FbrGBjqyARYWynJYwOjfynDPhjVK%2FH9eye8krLCnrmCRs42QdJsFYTbUuTG9QXvo8uVY%2BWKujV5rZ38tCPfxYDigPDZIm5HwzhVyN6fDKpHwHFLqPoXdGl0m6K7zsnyBd7nOaKX5dXVjsQcC8DseurEd4HkVd1WLiGbV9ADtyhKGQVof5WWTwr49E6NiUGsD97oZmq6kpn0Qy5BcdmxgEnT6%2FIFlxfJkbm93L59dItI6f3clT%2FrzMaQ%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=093cc096820ad4c98c3221faf9105c891c8903e188db3d218dda82c727240d2a"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2024-21896"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2024-05-29T14:32:15.660Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2024-04-29T14:32:12.707Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "**Summary:** In Node.js 20 and Node.js 21, the permission model protects itself against path traversal attacks by calling `path.resolve()` on any paths given by the user. If the path is to be treated as a `Buffer`, the implementation uses `Buffer.from()` to obtain a `Buffer` from the result of `path.resolve()`. By monkey-patching `Buffer` internals, namely, `Buffer.prototype.utf8Write`, the application can modify the result of `path.resolve()`, which leads to a path traversal vulnerability.\n\n**Description:** This vulnerability was introduced in [commit 1f64147e](https://github.com/nodejs/node/commit/1f64147eb607f82060e08884f993597774c69280), which itself was a patch of a path traversal vulnerability (see CVE-2023-32004, [report 2038134](https://hackerone.com/reports/2038134)). Subsequent commits made the implementation more resilient against monkey-patching, for example, by not allowing users to replace `path.resolve()` ([commit 32bcf4ca](https://github.com/nodejs/node/commit/32bcf4ca27bba9d4e48418f12dc6d7c2252e71ec)) or `Buffer.from()` ([commit f447a461](https://github.com/nodejs/node/commit/f447a4611a49d1843c17bf9ffbc86a835f1f1b9c)) with user-defined functions. Nevertheless, the internals of `Buffer.from` can be monkey-patched in multiple ways. Most importantly, overwriting `Buffer.prototype.utf8Write` with a user-defined function enables a straightforward path traversal vulnerability because virtually any sanitization performed by `path.resolve()` can be overridden by the user.\n\n## Steps to reproduce:\n\nThis can be exploited simply by overwriting `Buffer.prototype.utf8Write` with a user-defined function. The code is supposed to only have access to `/tmp`, yet it successfully reads `/etc/passwd`.\n\n```\n$ node --experimental-permission --allow-fs-read=/tmp \nWelcome to Node.js v20.8.1.\nType \".help\" for more information.\n> Buffer.prototype.utf8Write = ((w) => function (str, ...args) {\n...   return w.apply(this, [str.replace(/^\\/exploit/, '/tmp/..'), ...args]);\n... })(Buffer.prototype.utf8Write);\n[Function (anonymous)]\n> fs.readFileSync(new TextEncoder().encode('/exploit/etc/passwd'))\n<Buffer 72 6f 6f 74 3a 78 3a 30 3a 30 3a 72 6f 6f 74 3a 2f 72 6f 6f 74 3a 2f 62 69 6e 2f 62 61 73 68 0a 64 61 65 6d 6f 6e 3a 78 3a 31 3a 31 3a 64 61 65 6d 6f ... 3174 more bytes>\n```\n\nThis example pretends to attempt to read `/exploit/etc/passwd`, which would ultimately be denied. However, after the permission model implementation has called `path.resolve()`, the exploit intercepts the internal call to `utf8Write()` within `Buffer.from()` and replaces the sanitized path with `/tmp/../etc/passwd`, thus bypassing the path traversal protection logic. Because Node.js assumes that the path has been resolved at this point, it allows access because the path begins with `/tmp/`.\n\n## Suggested minimal patch:\n\n```patch\ndiff --git a/lib/internal/fs/utils.js b/lib/internal/fs/utils.js\nindex 611b6c2420..d7e6ec3aa2 100644\n--- a/lib/internal/fs/utils.js\n+++ b/lib/internal/fs/utils.js\n@@ -66,4 +66,6 @@ const kStats = Symbol('stats');\n const assert = require('internal/assert');\n \n+const { encodeUtf8String } = internalBinding('encoding_binding');\n+\n const {\n   fs: {\n@@ -720,5 +722,8 @@ function possiblyTransformPath(path) {\n     assert(isUint8Array(path));\n     if (!BufferIsBuffer(path)) path = BufferFrom(path);\n-    return BufferFrom(resolvePath(BufferToString(path)));\n+    // Avoid Buffer.from() and use a C++ binding instead to encode the result\n+    // of path.resolve() in order to prevent path traversal attacks that\n+    // monkey-patch Buffer internals.\n+    return encodeUtf8String(resolvePath(BufferToString(path)));\n   }\n   return path;\n```\n\n## Supporting Material/References:\n\n* The [vulnerable implementation of `possiblyTransformPath()`](https://github.com/nodejs/node/blob/9f46adf5bc14a7af8ec55be1d02fa46ed80720f2/lib/internal/fs/utils.js#L712-L725).\n* [Commit 1f64147e](https://github.com/nodejs/node/commit/1f64147eb607f82060e08884f993597774c69280), which introduced the vulnerability.\n* Previous path traversal vulnerabilities: CVE-2023-30584, CVE-2023-32004, CVE-2023-39331, and CVE-2023-39332.\n\n## Impact\n\nThe impact is virtually the same as that of previous path traversal vulnerabilities: CVE-2023-30584, CVE-2023-32004, CVE-2023-39331, and CVE-2023-39332. Applications can access file system paths that access should be denied to based on the configured process permissions, and may be able to perform write operations on read-only resources.\n\nThis affects the most recent versions of Node.js on both the Node.js 20 and Node.js 21 release lines.",
  "bounty_amount": "2430.0",
  "formatted_bounty": "$2,430",
  "weakness": {
    "id": 19,
    "name": "Path Traversal"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2024-05-29T14:32:12.992Z",
  "allow_singular_disclosure_after": -41401233.0485096,
  "singular_disclosure_allowed": true,
  "vote_count": 66,
  "voters": [
    "metereorpreter",
    "xavoppa",
    "n1m0",
    "zy9ard3",
    "never_die",
    "2026",
    "zack0x01",
    "hundredpercent",
    "ahmedsamye777",
    "idealphaseth",
    "and 56 more..."
  ],
  "severity": {
    "rating": "high",
    "author_type": "User"
  },
  "structured_scope": {
    "databaseId": 83651,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "https://github.com/nodejs/node",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "id": 439318,
      "category": "team",
      "content": "Path traversal by monkey-patching Buffer internals (CVE-2024-21896) - (High)\nThe permission model protects itself against path traversal attacks by calling path.resolve() on any paths given by the user. If the path is to be treated as a Buffer, the implementation uses Buffer.from() to obtain a Buffer from the result of path.resolve().\n\nBy monkey-patching Buffer internals, namely, Buffer.prototype.utf8Write, the application can modify the result of path.resolve(), which leads to a path traversal vulnerability.\n\nImpacts:\nThis vulnerability affects all users using the experimental permission model in active release lines: 20.x and 21.x.\n\nPlease note that at the time this CVE was issued, the permission model is an experimental feature of Node.js. Thank you, to Tobias Nießen for reporting this vulnerability and for fixing it.\n\nFull Security Advisory: https://nodejs.org/en/blog/vulnerability/february-2024-security-releases",
      "updated_at": "2024-04-29T14:29:09.825Z",
      "can_view?": true,
      "can_create?": false,
      "attachments": [],
      "user": {
        "id": 904892,
        "username": "kunderkoffler",
        "name": "Kayla Underkoffler",
        "bio": null,
        "cleared": false,
        "verified": false,
        "website": null,
        "location": null,
        "created_at": "2020-01-13T19:26:22.339Z",
        "url": "https://hackerone.com/kunderkoffler",
        "hackerone_triager": false,
        "hackerone_employee": false,
        "user_type": "company",
        "profile_picture_urls": {
          "small": "/assets/avatars/default-14ffa99f59cd01423c64904352cc130ffcb6a802eadfd11777a54485749e60f2.png",
          "medium": "/assets/avatars/default-14ffa99f59cd01423c64904352cc130ffcb6a802eadfd11777a54485749e60f2.png",
          "xtralarge": "/assets/avatars/default-14ffa99f59cd01423c64904352cc130ffcb6a802eadfd11777a54485749e60f2.png"
        }
      }
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
