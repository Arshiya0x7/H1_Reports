{
  "id": 946728,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85NDY3Mjg=",
  "url": "https://hackerone.com/reports/946728",
  "title": "SafeParamsHelper::safe_params is not so safe",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2020-07-29T13:31:45.285Z",
  "submitted_at": "2020-07-29T13:31:45.285Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "vakzz",
    "url": "/vakzz",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/6zbovkumst7oljmo9v21pig3yh9j/3cb67cc78dc0cba55b102dd9eca2ee89b206d3e960be830f070583d9070b69ef?response-content-disposition=inline%3B%20filename%3D%2294971b5a75a669ea52903c09fc847f3434930258211181557be06162f5a8bac0.jpg%22%3B%20filename%2A%3DUTF-8%27%2794971b5a75a669ea52903c09fc847f3434930258211181557be06162f5a8bac0.jpg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ6BUINIA7%2F20250921%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250921T083504Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQC%2BZthqetx2sYvk5flV%2B4ullL1qpu8SCbabmro3z3bbywIgWYlIMV%2B6FUb%2BTGJm%2BEaotptUep9S9656WlFEiRyVllsquwUI%2Ff%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARADGgwwMTM2MTkyNzQ4NDkiDHwalTtqDeQ1l%2BPo6CqPBTS9MjwAKuzBO10OiRfpOYYqAQaxkNfbAJvTFd5KU6p6WzRIpqT4hzlI8VhpQkBEdFgwVavKkSXQzD%2BO%2FUloaT42YaflOEh0JOfpGfPFRpLqz%2Fr2MghJonM1vsrmP37dJSj6Tc8E3eVLGjqZK3kEtP5GtWr5yhobRq9Y9Cy2bwekNvMW2xxEQyyogAsQHZrHOeDLCqKygH1Xv%2BmXsPA1vo1%2FPjXS0fGE7%2F9zo5%2BO%2BAd4laRphBm6n9IWZ%2B6FvwbH2xQIZnNVGj3UR0NxmdYTdTysXGxto0t4grhXKgoQdZDy8k1uSo6nY5myfi%2BIsay32sXvLW0rbaMj9HOc2KtmTuslZJssVxyBQISIVJNni1L9F6BxnpqNIZcsFyUbuJDMh6%2F%2BQrWLGrcUXuU3rjLFFTv5gb0GcQpVP5pmlgmqbVwc4An4TcWEj8eTGgEhVyYLU%2FxHCSKLS06efmL3Tmmqmc0zzuKgC95aCV6fjI4nYeDbqGgxlV3QAPUQjZ%2F7TQa9%2BSNwd8jTo5q%2ByKuq%2BdcKwGWF4mhEoEnQ4ZpvMIyyih8fuAIU8La8ka2J6Ltp%2BpQIdj3QTafU0lHkff%2B7SKuNe3Pwj30bDnAZmgWT%2BADOBY%2FMI4aubXCKI25zs6p%2Bqp4Tu4vF7pv8w5u5d0i1sT%2BdFMv1pEpw42ERGmc3h4ascBBUAPbZnHyuRn8eDr1W0cI%2B%2FnxN7ltBP9geKer2S91N%2BDqNd0xdHpE0vwsOEWXbgVlkJ9SLRDCG7ZBPz%2FAqmqUVQxjShqwpSrNX28kkLE6Czn68I5Qd2kllilkdlzsNeqaySc%2BK8fU0eChYoyOluM5w1u0nAe3RxIjge9%2FOQjMtaAV7ca%2B8KMu%2FULoiFuTE8fswweu9xgY6sQEpW17fj7I6F10aYrpSEScqbNmCrBF52CxvX4uUHutdUoZqooJOL8Hl71qx%2BDWXPAnER%2B%2B3WqM1yGAOkQB8gZoiGU9No9wDRLLXEqv70ndooW6egLwu%2FvGVTnAsnXQu7qdUYPv80VSVjn4jp2A3IuXR%2FbhwrxEObgTrAisxB9dYZdrIkDl1gaQXI19KHI%2FD0OQzBCV%2F%2FAT8ltvXojLO0BqiBpT%2Fv1ZMKD1Jmo0IlbyrHK0%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=a4f02cb7eefff9e8da55308e957f3fc74c45569b0b64db15418b75fa0bfc5242"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 264,
    "url": "https://hackerone.com/gitlab",
    "handle": "gitlab",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/235acf2ba808c3a51a94888fb977392c26f8fb0ccf77a81a4546c5e4065c06f1",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/3f1ab5c6a9b6dadada1e6c8121700b884388bd0a43471fee1897a38ce57d0b2c"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "pentest_retesting_ends_at": null,
    "profile": {
      "name": "GitLab",
      "twitter_handle": "gitlab",
      "website": "https://about.gitlab.com",
      "about": "A single application for the entire software development lifecycle."
    }
  },
  "has_bounty?": true,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "submitted_with_assistant": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2020-11-02T21:19:01.556Z",
  "bug_reporter_agreed_on_going_public_at": "2020-11-02T21:19:01.513Z",
  "team_member_agreed_on_going_public_at": "2020-11-02T15:22:48.138Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "### Summary\n\nGitLab uses [SafeParamsHelper](https://gitlab.com/gitlab-org/gitlab/-/blob/682a3c0134f2cfec9e5743aa97fbaf2a7d89e65f/app/helpers/safe_params_helper.rb#L8) to filter out some keys before passing them to `url_for`: \n\n```ruby\n  def safe_params\n    if params.respond_to?(:permit!)\n      params.except(:host, :port, :protocol).permit!\n    else\n      params\n    end\n  end\n```\n\nThe issue is that there are a [lot more dangerous keys](https://github.com/rails/rails/blob/12f3f11f61eccc5d9423b288a08cb1fc7e60999b/actionpack/lib/action_dispatch/routing/route_set.rb#L781):\n\n```ruby\nRESERVED_OPTIONS = [:host, :protocol, :port, :subdomain, :domain, :tld_length,\n                          :trailing_slash, :anchor, :params, :only_path, :script_name,\n                          :original_script_name, :relative_url_root]\n```\n\nThis means that anywhere `safe_params` is used, the domain could be changed using the `domain` query. Most of the `build_canonical_path` methods call `url_for(safe_params)` which then gets used by [RoutableActions](https://gitlab.com/gitlab-org/gitlab/-/blob/682a3c0134f2cfec9e5743aa97fbaf2a7d89e65f/app/controllers/concerns/routable_actions.rb#L54):\n\n```ruby\ndef ensure_canonical_path(routable, requested_full_path)\n    return unless request.get?\n\n    canonical_path = routable.full_path\n    if canonical_path != requested_full_path\n      if !request.xhr? && request.format.html? && canonical_path.casecmp(requested_full_path) != 0\n        flash[:notice] = \"#{routable.class.to_s.titleize} '#{requested_full_path}' was moved to '#{canonical_path}'. Please update any links and bookmarks that may still have the old path.\"\n      end\n\n      redirect_to build_canonical_path(routable)\n    end\n  end\n```\n\nThis creates an open redirect in all of the `RoutableActions` routes by making `canonical_path != requested_full_path` (eg using a capital letter) and adding the `domain` param:\n\n1. Visit https://gitlab.com/vakzz-h1/Redirect1?domain=aw.rs\n1. You will be redirected to https://aw.rs/\n\nThe other key that can be abused is `script_name`, as this is appended to the start of the url and can be used to fake a protocol such as javascript:\n\n1. Visit https://gitlab.com/vakzz-h1/redirect1/-/issues?script_name=javascript:alert(1)//\n1. Look at the RSS Feed link\n\n    ```html\n<a class=\"btn btn-svg has-tooltip\" data-container=\"body\" title=\"\"  href=\"javascript:alert(1)//vakzz-h1/redirect1/-/issues.atom?feed_token=XXXX&amp;state=opened\" data-original-title=\"Subscribe to RSS feed\">\n  <svg class=\"s16 qa-rss-icon\" data-testid=\"rss-icon\">\n    <use xlink:href=\"https://gitlab.com/assets/icons-37f758fe6359f04ae912169432d8ddd9dd45a1316d8fa634996c10bd033e9726.svg#rss\"></use>\n  </svg>\n</a>\n   ```\n1. On gitlab.com this is blocked by the CSP\n\nThere are a bunch of other places that use `safe_params` that could be exploited such as the [_viewer.html.haml](https://gitlab.com/gitlab-org/gitlab/-/blob/682a3c0134f2cfec9e5743aa97fbaf2a7d89e65fapp/views/projects/blob/_viewer.html.haml#L7)\n\n```haml\n- viewer_url = local_assigns.fetch(:viewer_url) { url_for(safe_params.merge(viewer: viewer.type, format: :json)) } if load_async\n.blob-viewer{ data: { type: viewer.type, rich_type: rich_type, url: viewer_url, path: viewer.blob.path }, class: ('hidden' if hidden) }\n```\n\nThis allows an attacker to specify the `viewer_url` for the blob url. Since the json returned by the url has an `html` attributes it allows arbitrary html to be inserted. The below uses https://gitlab.com/-/snippets/1999965 as the viewer url and 1 click csp bypass (same as https://hackerone.com/reports/662287#activity-6026826) with https://gitlab.com/-/snippets/1999974/raw for the js payload:\n\n1. Visit https://gitlab.com/vakzz-h1/redirect1/-/blob/master/test.txt?script_name=/-/snippets/1999965/raw%23\n1. See the injected HTML:\n\n    ```html\n<form>any <b>html</b> can go <button>here<a data-remote=\"true\" data-method=\"get\" data-type=\"script\" href=\"https://gitlab.com/-/snippets/1999974/raw\" class=\"atwho-view select2-drop-mask pika-select\">\n  <img width=\"10000\" height=\"10000\">\n</a></button></form>\n    ```\n1. Clicking anywhere will trigger an alert\n\nI've only skimmed the other locations that use `safe_params` but it looks like there are a few more that load data via javascript or could be turned into open redirects. I also haven't looked into the impact of the open redirects to see if they could be escalated to leak sensitive information, I'll update the report if I find anything else.\n\nI've put all of these in a single report as the mitigation is the same for all of them, but if you would like me to split them into separate reports I can do that as well. I've also set the severity to high due to the number of places that this is used and relative ease of trigger it, but the individual issues are probably less so might need to be adjusted. \n\n### What is the current *bug* behavior?\n\n`SafeParamsHelper.safe_params` only filters out the keys `:host, :port, :protocol` but there are other dangerous ones\n\n### What is the expected *correct* behavior?\n`SafeParamsHelper.safe_params` should filter out all of the reserved options:\n\n```ruby\nRESERVED_OPTIONS = [:host, :protocol, :port, :subdomain, :domain, :tld_length,\n                          :trailing_slash, :anchor, :params, :only_path, :script_name,\n                          :original_script_name, :relative_url_root]\n```\n\n\n### Output of checks\nThis bug happens on GitLab.com\n\n## Impact\n\n* open redirect on quire a few routes\n* reflected xss using the `javascript` protocol\n* reflected xss with csp bypass using the blob viewer",
  "bounty_amount": "4000.0",
  "formatted_bounty": "$4,000",
  "weakness": {
    "id": 61,
    "name": "Cross-site Scripting (XSS) - Reflected"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": null,
  "vote_count": 24,
  "voters": [
    "sky003",
    "n1m0",
    "foobar7",
    "ali",
    "tess",
    "nischalxd",
    "h4x0r_dz",
    "spaghettisec",
    "naategh",
    "mr-alienx-kurd",
    "and 14 more..."
  ],
  "severity": {
    "rating": "high",
    "author_type": "User"
  },
  "structured_scope": {
    "databaseId": 18138,
    "asset_type": "URL",
    "asset_identifier": "gitlab.com",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
